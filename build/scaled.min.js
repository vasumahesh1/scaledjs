function diamondStep(a,b,c,d){var e=Math.floor(d/2),f=Math.floor(e/2);Commons.Log("HalfBoxSize",e,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("QuarterBoxSize",f,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Avreage of",["["+(b-e)+"],["+(c-e)+"]","["+(b-e)+"],["+(c+e)+"]","["+(b+e)+"],["+(c-e)+"]","["+(b+e)+"],["+(c+e)+"]"],Commons.validLogKeys.diamondSquareLogKey),a[b][c]=Commons.GetAverage([a[b-e][c-e],a[b-e][c+e],a[b+e][c-e],a[b+e][c+e]]),Commons.Log("Value of Center ["+b+"]["+c+"]",a[b][c],Commons.validLogKeys.diamondSquareLogKey),e>=2&&(diamondStep(a,b-f,c-f,e),diamondStep(a,b+f,c-f,e),diamondStep(a,b-f,c+f,e),diamondStep(a,b+f,c+f,e))}function squareStep(a,b,c,d){var e=Math.floor(d/2),f=Math.floor(e/2);Commons.Log("HalfBoxSize",e,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("QuarterBoxSize",f,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Avreage of",["["+(b-e)+"],["+(c-e)+"]","["+b+"],["+c+"]","["+(b-e)+"],["+(c+e)+"]","["+(b-d)+"],["+c+"]"],Commons.validLogKeys.diamondSquareLogKey),a[b-e][c]=Commons.GetAverage([Commons.TryGetArrayValue(a,b-e,c-e),Commons.TryGetArrayValue(a,b,c),Commons.TryGetArrayValue(a,b-e,c+e),Commons.TryGetArrayValue(a,b-d,c)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+(b-e)+"]["+c+"]",a[b-e][c],Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Avreage of",["["+(b+e)+"],["+(c-e)+"]","["+b+"],["+c+"]","["+(b+e)+"],["+(c+e)+"]","["+(b+d)+"],["+c+"]"],Commons.validLogKeys.diamondSquareLogKey),a[b+e][c]=Commons.GetAverage([Commons.TryGetArrayValue(a,b+e,c-e),Commons.TryGetArrayValue(a,b,c),Commons.TryGetArrayValue(a,b+e,c+e),Commons.TryGetArrayValue(a,b+d,c)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+(b+e)+"]["+c+"]",a[b+e][c]),Commons.Log("Getting Avreage of",["["+(b-e)+"],["+(c-e)+"]","["+b+"],["+c+"]","["+(b+e)+"],["+(c-e)+"]","["+b+"],["+(c-d)+"]"],Commons.validLogKeys.diamondSquareLogKey),a[b][c-e]=Commons.GetAverage([Commons.TryGetArrayValue(a,b-e,c-e),Commons.TryGetArrayValue(a,b,c),Commons.TryGetArrayValue(a,b+e,c-e),Commons.TryGetArrayValue(a,b,c-d)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+b+"]["+(c-e)+"]",a[b][c-e],Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Avreage of",["["+(b-e)+"],["+(c+e)+"]","["+b+"],["+c+"]","["+(b+e)+"],["+(c+e)+"]","["+b+"],["+(c+d)+"]"],Commons.validLogKeys.diamondSquareLogKey),a[b][c+e]=Commons.GetAverage([Commons.TryGetArrayValue(a,b-e,c+e),Commons.TryGetArrayValue(a,b,c),Commons.TryGetArrayValue(a,b+e,c+e),Commons.TryGetArrayValue(a,b,c+d)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+b+"]["+(c+e)+"]",a[b][c+e],Commons.validLogKeys.diamondSquareLogKey),e>=2&&(squareStep(a,b-f,c-f,e),squareStep(a,b+f,c-f,e),squareStep(a,b-f,c+f,e),squareStep(a,b+f,c+f,e))}var Commons={debug:!1,allowedLogs:["all"],validLogKeys:{mapInitializeLogKey:"mapInit",diamondSquareLogKey:"diamondSquare",mapValidationLogKey:"mapValidation"},showProgressUpdate:function(){}},PLUS_MINUS_BAR=4;Commons.ConsoleLog=function(a,b){this.debug===!0},Commons.Log=function(a,b,c){this.debug!==!0||-1==this.allowedLogs.indexOf(c)&&"all"!=this.allowedLogs[0]||this.ConsoleLog(a,b)},Commons.Warn=function(a){this.debug===!0},Commons.Error=function(a){this.debug===!0},Commons.RoundNumber=function(a){return Math.round(a)},Commons.Randomize=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},Commons.RandomizeInArray=function(a){var b=0,c=a.length-1,d=this.Randomize(b,c);return a[d]},Commons.RandomizeWithException=function(a,b,c){var d=-1;do d=this.Randomize(a,b);while(-1!=c.indexOf(d));return d},Commons.RandomizePlusMinus=function(a,b){{var c=this.Randomize(1,10);this.Randomize(a,b)}return PLUS_MINUS_BAR>=c?-1*c:c},Commons.GetAverage=function(a){this.Log("Array Came",a);var b=0,c=0;for(var d in a)-1!=a[d]&&(b+=a[d],c++);var e=b/c;return this.Log("Avg",e),e},Commons.TryGetArrayValue=function(a,b,c){return b in a&&c in a[b]?a[b][c]:-1};var ScaledMap=function(){this.terrains=[],this.mapValues=[],this.mapValidityReports=[],this.rowSize=33,this.columnSize=33,this.mapInitValue=-1,this.hasDefaultTerrain=!1,this.startTerrainKeys=["","","",""],this.startTerrainValues=[],this.isInited=!1,this.GetDefaultTerrain=function(){for(var a in this.terrains)if(this.terrains[a].terrainDefault===!0)return this.terrains[a]},this.GetMainTerrains=function(){var a=[];for(var b in this.terrains)"terrain"==this.terrains[b].terrainType&&a.push(this.terrains[b]);return a},this.GetTerrainByKey=function(a){for(var b in this.terrains)if(this.terrains[b].terrainKey==a)return this.terrains[b]}};ScaledMap.prototype.SetDimensions=function(a,b){this.rowSize=a,this.columnSize=b},ScaledMap.prototype.AddTerrain=function(a){var b=new ScaledTerrain;"zLevel"in a?b.CreateTerrain(a.label,a.key,a.max,a.min,a.zLevel):b.CreateTerrain(a.label,a.key,a.max,a.min,0),"type"in a&&b.SetType(a.type),"default"in a&&this.hasDefaultTerrain===!1&&(this.hasDefaultTerrain=!0,b.SetDefault()),Commons.Log("Adding Terrain",b),this.terrains.push(b)},ScaledMap.prototype.AddStartingCondition=function(a){var b=this.GetTerrainByKey(a.terrainKey);b.terrainStartCount=a.minCount,b.terrainStartPercent=a.optionalPercent},ScaledMap.prototype.AddValidationRule=function(a){var b=a.terrainKey,c=-1,d=-1;"minPercent"in a&&(c=a.minPercent),"maxPercent"in a&&(d=a.maxPercent),this.GetTerrainByKey(b).SetValidation(c,d)},ScaledMap.prototype.CheckRegularTerrainValidity=function(){var a=this.GetMainTerrains(),b=!0;for(var c in a){var d=this.GetLayerPercentage(a[c].terrainKey),e=null;-1!=a[c].terrainValidationMinPercent&&d<a[c].terrainValidationMinPercent&&(b=!1,e=new ScaledValidityReport(a[c].terrainKey,Math.abs(d-a[c].terrainValidationMinPercent),!0)),-1!=a[c].terrainValidationMaxPercent&&d>a[c].terrainValidationMaxPercent&&(b=!1,e=new ScaledValidityReport(a[c].terrainKey,Math.abs(d-a[c].terrainValidationMaxPercent),!1)),null!==e&&this.mapValidityReports.push(e)}return Commons.Log("Validity Reports",this.mapValidityReports,Commons.validLogKeys.mapValidationLogKey),b},ScaledMap.prototype.GetLayerPercentage=function(a){var b=0,c=this.rowSize*this.columnSize,d=this.GetTerrainByKey(a);for(var e in this.mapValues)for(var f in this.mapValues)this.mapValues[e][f]<=d.terrainUpperValue&&this.mapValues[e][f]>=d.terrainLowerValue&&b++;var g=b/c*100;return Commons.Log(d.terrainKey+" Percentage of Terrain",g,Commons.validLogKeys.mapValidationLogKey),g},ScaledMap.prototype.GetLayersFromValue=function(a){var b=[];for(var c in this.terrains)this.terrains[c].terrainUpperValue>=a&&this.terrains[c].terrainLowerValue<=a&&b.push(this.terrains[c]);return b},ScaledMap.prototype.Init=function(){if(this.isInited===!1){for(this.hasDefaultTerrain===!1&&terrains[0].SetDefault(),i=0;i<this.rowSize;i++){var a=[];for(j=0;j<this.columnSize;j++)a.push(this.mapInitValue);this.mapValues.push(a)}this.isInited=!0}},ScaledMap.prototype.InitStartingConditions=function(){this.startTerrainKeys=["","","",""],this.startTerrainValues=[];var a=[],b=0,c=this.GetMainTerrains();Commons.Log("Regular Terrains",c);for(var d in c)if(c[d].terrainStartCount>0){var e={};e.terrainKey=c[d].terrainKey,e.count=c[d].terrainStartCount,e.nextPercent=c[d].terrainStartPercent,b+=c[d].terrainStartCount,a.push(e)}a.sort(function(a,b){return b.count-a.count});var f=4,g=[];if(4>=b){f=4-b;for(var h in a)for(j=0;j<a[h].count;j++){var k=Commons.RandomizeWithException(0,3,g);g.push(k),this.startTerrainKeys[k]=a[h].terrainKey}}if(0!==f){var l=0,m=[],n=[];for(var o in c){var p={};c[o].terrainStartPercent>0?(l+=c[o].terrainStartPercent,p.terrainKey=c[o].terrainKey,p.cumulativePercent=l,m.push(p)):(p.terrainKey=c[o].terrainKey,n.push(p))}if(l>100);else for(i=0;i<f;i++){var q=Commons.RandomizeWithException(0,3,g);g.push(q);var r=Commons.Randomize(0,100),s=null,t=!1;for(var u in m)if(r<=m[u].cumulativePercent){t=!0,s=m[u].terrainKey;break}t===!1&&(s=Commons.RandomizeInArray(n).terrainKey),this.startTerrainKeys[q]=s}}Commons.Log("Start Terrain Keys",this.startTerrainKeys);for(var v in this.startTerrainKeys){var w=this.GetTerrainByKey(this.startTerrainKeys[v]);this.startTerrainValues.push(w.GetRandomTerrainValue())}Commons.Log("Start Terrain Values",this.startTerrainValues),this.mapValues[0][0]=this.startTerrainValues[0],this.mapValues[0][this.columnSize-1]=this.startTerrainValues[1],this.mapValues[this.rowSize-1][0]=this.startTerrainValues[2],this.mapValues[this.rowSize-1][this.columnSize-1]=this.startTerrainValues[3]},ScaledMap.prototype.GenerateMapValues=function(){Commons.Warn("Map Init Starting"),this.Init(),this.InitStartingConditions(),this.mapValidityReports=[],Commons.Warn("Diamond Square Algorithm Starting"),this.mapValues=diamondSquare(this.mapValues,this.rowSize-1),this.CleanMap()},ScaledMap.prototype.CleanMap=function(){for(var a in this.mapValues)for(var b in this.mapValues)this.mapValues[a][b]<0&&(this.mapValues[a][b]=0),this.mapValues[a][b]>100&&(this.mapValues[a][b]=100)};var diamondSquare=function(a,b){return Commons.Warn("Diamond Step Starting"),diamondStep(a,b/2,b/2,b),Commons.Warn("Square Step Starting"),squareStep(a,b/2,b/2,b),a},ScaledTerrain=function(){this.terrainUpperValue=-1,this.terrainLowerValue=-1,this.terrainLabel=-1,this.terrainKey=-1,this.terrainZLevel=-1,this.terrainType="terrain",this.terrainDefault=!1,this.terrainStartCount=0,this.terrainStartPercent=0,this.terrainValidationMinPercent=-1,this.terrainValidationMaxPercent=-1};ScaledTerrain.prototype.CreateTerrain=function(a,b,c,d,e){this.terrainUpperValue=c,this.terrainLowerValue=d,this.terrainKey=b,this.terrainLabel=a,this.terrainZLevel=e},ScaledTerrain.prototype.SetStartingCondition=function(a,b){this.terrainStartPercent=b,this.terrainStartCount=a},ScaledTerrain.prototype.SetDefault=function(){this.terrainDefault=!0},ScaledTerrain.prototype.SetType=function(a){this.terrainType=a},ScaledTerrain.prototype.GetRandomTerrainValue=function(){return Commons.Randomize(this.terrainLowerValue,this.terrainUpperValue)},ScaledTerrain.prototype.IsRegularTerrain=function(){return"terrain"==this.terrainType?!0:!1},ScaledTerrain.prototype.SetValidation=function(a,b){this.terrainValidationMinPercent=a,this.terrainValidationMaxPercent=b};var ScaledValidityReport=function(a,b,c){this.terrainKey=a,this.repairMagnitude=b,this.positiveIncrease=c},ScaledGen=function(a){this.maxTries=10,a&&("debug"in a&&a.debug===!0&&(Commons.debug=!0),"logs"in a&&(Commons.allowedLogs=a.logs),"maxTries"in a&&(this.maxTries=a.maxTries),"onProgressUpdate"in a&&(Commons.showProgressUpdate=a.onProgressUpdate)),this.mainMap=new ScaledMap};ScaledGen.prototype.GetMapValues=function(){return this.mainMap.mapValues},ScaledGen.prototype.SetMapSize=function(a,b){this.mainMap.rowSize=a,this.mainMap.columnSize=b},ScaledGen.prototype.AddTerrain=function(a){this.mainMap.AddTerrain(a)},ScaledGen.prototype.AddStartingCondition=function(a){this.mainMap.AddStartingCondition(a)},ScaledGen.prototype.AddValidationRule=function(a){this.mainMap.AddValidationRule(a)},ScaledGen.prototype.GenerateMap=function(){var a=!1,b=0;do this.mainMap.GenerateMapValues(),a=this.mainMap.CheckRegularTerrainValidity(),b++;while(a===!1&&b<this.maxTries);a===!1&&Commons.Error("Unable to Validate Map. Perhaps Conditions set are too Strict.")},ScaledGen.prototype.RenderMapValues=function(a){var b=document.getElementById(a);b.innerHTML="";var c=this.mainMap.mapValues,d="";for(var e in c)d+=this.GenerateRow(c[e]);b.innerHTML=d},ScaledGen.prototype.GenerateRow=function(a){var b="<div class='row'>";for(var c in a)b+=this.GenerateCell(a[c]);return b+="</div>"},ScaledGen.prototype.GenerateCell=function(a){var b=this.mainMap.GetLayersFromValue(a),c="no-cell";for(var d in b)if(b[d].IsRegularTerrain()===!0){c=b[d].terrainKey;break}var e="";return e+="<div class='cell "+c+" ",e+="data-value='"+a+"' ",e+="'>",e+="</div>"};