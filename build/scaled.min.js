!function(a,b){"function"==typeof define&&define.amd?define(["scaled-gen"],b):"object"==typeof module&&module.exports?module.exports=b():a.ScaledGen=b()}(this,function(){var a=function(a){var b=10,c=new Scaled.ScaledMap,d=null,e=null,f=null;a&&(Scaled.Commons.debug=a.debug?!0:!1,Scaled.Commons.allowedLogs=a.logs?a.logs:[],Scaled.Commons.showProgressUpdate=a.onProgressUpdate?a.onProgressUpdate:function(){},b=a.maxTries?a.maxTries:10),this.getMapValues=function(){return c.getMapValues()},this.setMapSize=function(a,b){c.setDimensions(a,b)},this.addTerrain=function(a){c.addTerrain(a)},this.addStartingCondition=function(a){c.addStartingCondition(a)},this.addValidationRule=function(a){c.addValidationRule(a)},this.addLayerDomination=function(a){e=a},this.addTileset=function(a){f=a},this.setTileInfo=function(a){c.setTileInfo(a)},this.generateMapValues=function(){var a=!1,d=0;do c.generateMapValues(),a=c.checkRegularTerrainValidity(),d++;while(a===!1&&b>d);a===!1&&Scaled.Commons.error("Unable to Validate Map. Perhaps Conditions set are too Strict.")},this.generateMap=function(){if(this.generateMapValues(),e&&f){var a=c.getTmxSettings();a.domSettings=e,a.tilesetSettings=f,d=new Scaled.ScaledTmxGen(a),d.generateMapTmx()}else Scaled.Commons.warn("No Domination Settings / TileSet Settings provided skipping TMX Generation")},this.getTmxXml=function(){return d.getTmxXml()},this.getLayeredMap=function(){return d.getLayeredMap()},this.renderMapValues=function(a){var b=document.getElementById(a);b.innerHTML="";var d=c.getMapValues(),e="";for(var f in d)e+=g(d[f]);b.innerHTML=e},this.getRegularTerrainPercentages=function(){return c.getRegularTerrainPercentages()};var g=function(a){var b="<div class='row'>";for(var c in a)b+=h(a[c]);return b+="</div>"},h=function(a){var b=c.getLayersFromValue(a);Scaled.Commons.log("Terrains For Cell Value : "+a,b,Scaled.Commons.validLogKeys.mapRenderLogKey);var d="no-cell";for(var e in b)if(b[e].isRegularTerrain()===!0){d=b[e].getData().terrainKey;break}var f="";return f+="<div class='cell "+d+" ",f+="data-value='"+a+"' ",f+="'>",f+="</div>"}};return a});var Scaled=function(a){var b={debug:!1,allowedLogs:["all"],validLogKeys:{mapInitializeLogKey:"mapInit",diamondSquareLogKey:"diamondSquare",mapValidationLogKey:"mapValidation",mapRenderLogKey:"mapRender",tmxRenderLogKey:"tmxRender",decorationRenderLogKey:"decorationRender",correctionLogKey:"correction"},showProgressUpdate:function(){}},c=4;return b.consoleLog=function(a,b){this.debug===!0},b.log=function(a,b,c){this.debug!==!0||-1==this.allowedLogs.indexOf(c)&&"all"!=this.allowedLogs[0]||this.consoleLog("["+c+"] "+a,b)},b.warn=function(a){this.debug===!0},b.info=function(a){this.debug===!0},b.error=function(a){this.debug===!0},b.roundNumber=function(a){return Math.round(a)},b.randomize=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},b.randomizeInArray=function(a){var b=0,c=a.length-1,d=this.randomize(b,c);return a[d]},b.randomizeWithException=function(a,b,c){var d=-1;do d=this.randomize(a,b);while(-1!=c.indexOf(d));return d},b.randomizePlusMinus=function(a,b){{var d=this.randomize(1,10);this.randomize(a,b)}return c>=d?-1*d:d},b.randomizePlusMinusControlled=function(a,b,c,d,e){{var f=this.randomize(c,d);this.randomize(a,b)}return e>=f?-1*f:f},b.getAverage=function(a){this.log("Array Came",a);var b=0,c=0;for(var d in a)-1!=a[d]&&(b+=a[d],c++);var e=b/c;return this.log("Avg",e),e},b.tryGetArrayValue=function(a,b,c){return b in a&&c in a[b]?a[b][c]:-1},b.isPointAtEdge=function(a,b,c){return b=parseInt(b),c=parseInt(c),0===b||0===c?!0:b==a.length||c==a[0].length?!0:!1},b.getDefaultTerrain=function(a){for(var b in a)if(a[b].getData().terrainDefault===!0)return a[b]},b.getMainTerrains=function(a){var b=[];for(var c in a)a[c].isRegularTerrain()===!0&&b.push(a[c].getData());return b},b.removeKeyFromArray=function(a,b){for(var c in a)a[c]===b&&a.splice(c,1)},b.getDecorationTerrains=function(a){var b=[];for(var c in a)a[c].isDecorationTerrain()===!0&&b.push(a[c].getData());return b},b.getTerrainByKey=function(a,b){for(var c in a)if(a[c].terrainKey==b)return a[c];return!1},b.getTerrainMaximum=function(a){var b=-1,c=null;for(var d in a)a[d].isRegularTerrain()===!0&&a[d].getData().terrainUpperValue>b&&(b=a[d].getData().terrainUpperValue,c=a[d]);return c},b.getTerrainMinimum=function(a){var b=101,c=null;for(var d in a)a[d].isRegularTerrain()===!0&&a[d].getData().terrainLowerValue<b&&(b=a[d].getData().terrainLowerValue,c=a[d]);return c},a.Commons=b,a}(Scaled||{}),Scaled=function(a){var b=function(b){var c=b.terrains,d=b.domination,e=d.dominationPriority,f=function(a){return e.indexOf(a)},g=function(a){return e[a]},h=function(a,b){return a-b},i=function(a){for(var b={},c=[],d=0,e=a.length;e>d;++d)b.hasOwnProperty(a[d])||(c.push(a[d]),b[a[d]]=1);return c},j=function(a,b){var c=[];for(var d in b)c.push(-1!==b[d]&&f(b[d])<f(a)?b[d]:a);return c},k=function(b,c){var d,e=[],j=f(b);for(var k in c)if(-1!==c[k]){var l=f(c[k]);e.push(l)}a.Commons.log("Primary Value",b,a.Commons.validLogKeys.tmxRenderLogKey),a.Commons.log("Surroundings",c,a.Commons.validLogKeys.tmxRenderLogKey),a.Commons.log("Before Unique",e,a.Commons.validLogKeys.tmxRenderLogKey),e=i(e),a.Commons.log("After Unique",e,a.Commons.validLogKeys.tmxRenderLogKey),e.sort(h);var m=Math.min.apply(null,e);if(m==j)d=j;else{var n=e.indexOf(j);d=0!==n&&-1!=n?e[n-1]:e[0]}return a.Commons.log("Returning",g(d),a.Commons.validLogKeys.tmxRenderLogKey),g(d)};this.allSquareSidesSimilar=function(a){return a.top===!0&&a.left===!0&&a.right===!0&&a.bottom===!0?!0:!1},this.getDiagonalSimilarity=function(a,b){var c={topLeft:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,count:0};return b[0]==a&&(c.topLeft=!0,c.count++),b[1]==a&&(c.topRight=!0,c.count++),b[2]==a&&(c.bottomRight=!0,c.count++),b[3]==a&&(c.bottomLeft=!0,c.count++),c},this.getAdjacentSimilarity=function(a,b){var c={top:!1,left:!1,right:!1,bottom:!1,count:0};return b[0]==a&&(c.top=!0,c.count++),b[1]==a&&(c.right=!0,c.count++),b[2]==a&&(c.bottom=!0,c.count++),b[3]==a&&(c.left=!0,c.count++),c},this.resolveTileValue=function(b,d,e){if(a.Commons.getDefaultTerrain(c).terrainKey==b)return[];a.Commons.log("Primary Cell Layer",b,a.Commons.validLogKeys.tmxRenderLogKey),a.Commons.log("Adjacent Values",d,a.Commons.validLogKeys.tmxRenderLogKey),a.Commons.log("Diagonal Values",e,a.Commons.validLogKeys.tmxRenderLogKey);var f=[],g=a.Commons.getTerrainByKey(c,b),h=k(b,d);a.Commons.log("Lowest Domination",h,a.Commons.validLogKeys.tmxRenderLogKey);var i=a.Commons.getTerrainByKey(c,h).getTileData("other-tiles","all","fullValue");f.push(i);var l=j(b,d),m=j(b,e),n=this.getAdjacentSimilarity(b,l),o=this.getDiagonalSimilarity(b,m);return a.Commons.log("Similarity",n,a.Commons.validLogKeys.tmxRenderLogKey),this.allSquareSidesSimilar(n)===!0?f.push(g.getTileData("other-tiles","all","fullValue")):0===n.count?f.push(g.getTileData("open-tiles","open","noneValue")):n.top===!0&&n.left===!0&&n.right===!0?f.push(g.getTileData("enclosing-tiles","top","topValue")):n.bottom===!0&&n.left===!0&&n.right===!0?f.push(g.getTileData("enclosing-tiles","bottom","bottomValue")):n.top===!0&&n.bottom===!0&&n.right===!0?f.push(g.getTileData("enclosing-tiles","right","rightValue")):n.top===!0&&n.bottom===!0&&n.left===!0?f.push(g.getTileData("enclosing-tiles","left","leftValue")):n.top===!0&&n.left===!0?f.push(g.getTileData("excluding-tiles","bottom","rightValue")):n.top===!0&&n.right===!0?f.push(g.getTileData("excluding-tiles","bottom","leftValue")):n.bottom===!0&&n.left===!0?f.push(g.getTileData("excluding-tiles","top","rightValue")):n.bottom===!0&&n.right===!0?f.push(g.getTileData("excluding-tiles","top","leftValue")):n.bottom===!0&&n.top===!0?f.push(g.getTileData("open-tiles","parallel","topBottomValue")):n.left===!0&&n.right===!0?f.push(g.getTileData("open-tiles","parallel","leftRightValue")):n.top===!0?f.push(g.getTileData("open-tiles","open","topValue")):n.right===!0?f.push(g.getTileData("open-tiles","open","rightValue")):n.left===!0?f.push(g.getTileData("open-tiles","open","leftValue")):n.bottom===!0&&f.push(g.getTileData("open-tiles","open","bottomValue")),this.allSquareSidesSimilar(n)===!0&&4!==o.count&&(o.topLeft===!1&&f.push(g.getTileData("enclosing-tiles","bottom","rightValue")),o.topRight===!1&&f.push(g.getTileData("enclosing-tiles","bottom","leftValue")),o.bottomLeft===!1&&f.push(g.getTileData("enclosing-tiles","top","rightValue")),o.bottomRight===!1&&f.push(g.getTileData("enclosing-tiles","top","leftValue"))),a.Commons.log("Final Tiles",f,a.Commons.validLogKeys.tmxRenderLogKey),f}};return a.ScaledEdgeDetector=b,a}(Scaled||{}),Scaled=function(a){var b=function(a){this.terrainKey=a;var b=0,c=0,d=0;this.increment=function(){b++,d++,c=b/d*100},this.pass=function(){d++,c=b/d*100},this.getPercent=function(){return c}};return a.ScaledGenProgress=b,a}(Scaled||{}),Scaled=function(a){var b=function(){var b=[],c=[],d=[],e=[],f=[],g=[],h=[],k=[],l=33,m=33,n=-1,o=!1,p=["","","",""],q=[],r=!1,s=["terrain","decoration"],t=function(d){var e=0,f=l*m,g=a.Commons.getTerrainByKey(b,d);for(var h in c)for(var i in c)c[h][i]<=g.getData().terrainUpperValue&&c[h][i]>=g.getData().terrainLowerValue&&e++;var j=e/f*100;return a.Commons.log(g.getData().terrainKey+" Percentage of Terrain",j,a.Commons.validLogKeys.mapValidationLogKey),j},u=function(){if(r===!1){for(o===!1&&b[0].SetDefault(),i=0;i<l;i++){var d=[];for(j=0;j<m;j++)d.push(n);c.push(d)}a.Commons.log("Map Values Empty",c,a.Commons.validLogKeys.mapInitializeLogKey),r=!0}},v=function(a,b){return b.repairMagnitude-a.repairMagnitude},w=function(){p=["","","",""],q=[];var d,e=[],f=0,g=a.Commons.getMainTerrains(b);a.Commons.log("Regular Terrains",g,a.Commons.validLogKeys.mapInitializeLogKey);for(var h in g)if(g[h].terrainStartCount>0){var k={};k.terrainKey=g[h].terrainKey,k.count=g[h].terrainStartCount,k.nextPercent=g[h].terrainStartPercent,f+=g[h].terrainStartCount,e.push(k)}e.sort(function(a,b){return b.count-a.count});var n=4,o=[];if(4>=f){n=4-f;for(var r in e)for(j=0;j<e[r].count;j++){var s=a.Commons.randomizeWithException(0,3,o);o.push(s),p[s]=e[r].terrainKey}}if(a.Commons.log("Empty Non Optional Slots to Use",n,a.Commons.validLogKeys.mapInitializeLogKey),0!==n){var t=0,u=0,v=[],w=[];for(d in g){var x={};g[d].terrainStartPercent>0?(u+=g[d].terrainStartPercent,x.terrainKey=g[d].terrainKey,x.cumulativePercent=u,v.push(x)):(x.terrainKey=g[d].terrainKey,w.push(x))}if(u>100){a.Commons.warn("Optional percentages are not over 100, Normalizing Values to 0 to 100 Range");for(t in v)v[t].cumulativePercent=v[t].cumulativePercent/u*100}for(i=0;i<n;i++){var y=a.Commons.randomizeWithException(0,3,o);o.push(y);var z=a.Commons.randomize(0,u),A=null,B=!1;for(t in v)if(z<=v[t].cumulativePercent){B=!0,A=v[t].terrainKey;break}B===!1&&(A=a.Commons.randomizeInArray(w).terrainKey),p[y]=A}}a.Commons.log("Start Terrain Keys",p,a.Commons.validLogKeys.mapInitializeLogKey);for(var C in p){var D=a.Commons.getTerrainByKey(b,p[C]);q.push(D.getRandomTerrainValue())}a.Commons.log("Start Terrain Values",q,a.Commons.validLogKeys.mapInitializeLogKey),c[0][0]=q[0],c[0][m-1]=q[1],c[l-1][0]=q[2],c[l-1][m-1]=q[3],a.Commons.log("Map Values After Starting Values",c,a.Commons.validLogKeys.mapInitializeLogKey)},x=function(){var d=a.Commons.getTerrainMaximum(b).getData().terrainUpperValue,e=a.Commons.getTerrainMinimum(b).getData().terrainLowerValue;for(var g in c)for(var h in c)c[g][h]<e&&(c[g][h]=e),c[g][h]>d&&(c[g][h]=d);f=[]},y=function(){if(0!==f.length){for(var c in f)f[c].positiveIncrease?g.push(f[c]):h.push(f[c]);g.sort(v)}var d,e=0,i=0,j=0,l=0,m=0,n=a.Commons.getMainTerrains(b);k=[];for(d in n)k.push(new a.ScaledGenProgress(n[d].terrainKey)),n[d].terrainValidationMinPercent>=0&&(e+=n[d].terrainValidationMinPercent,j++),n[d].terrainValidationMaxPercent>=0&&(i+=n[d].terrainValidationMaxPercent,l++);if(e>100){m=100*j;for(d in b)if(b[d].isRegularTerrain()&&b[d].getData().terrainValidationMinPercent>=0){a.Commons.warn("Before"+b[d].terrainKey+" "+b[d].getData().terrainValidationMinPercent);var o=b[d].getData().terrainValidationMinPercent/m*100,p=b[d].getData().terrainValidationMaxPercent;b[d].setValidation(o,p)}}if(i>100){a.Commons.warn("Max Percent Validation Rules are Above 100% - Normalizing Values to range [0,100]"),m=100*l;for(d in b)if(b[d].isRegularTerrain()&&b[d].getData().terrainValidationMaxPercent>=0){var q=b[d].getData().terrainValidationMaxPercent/m*100,r=b[d].getData().terrainValidationMinPercent;b[d].setValidation(r,q)}}},z=function(b,c,d){if(0!==f.length){var e=0,g=!1;for(var h in f)f[h].terrainKey===c.terrainKey&&(e=f[h].repairMagnitude-d.getPercent(),g=f[h]);if(g){a.Commons.log("Correcting Values for "+c.terrainKey+" Current Percent: "+d.getPercent()+" Repair Percent Needed: ",g.repairMagnitude,a.Commons.validLogKeys.correctionLogKey);var i=!0,j=0;g.positiveIncrease?0>e&&(i=!1):e>0&&(i=!1);var k=15;k+=Math.abs(e),i?(j=a.Commons.randomizePlusMinusControlled(1,k,1,10,0),a.Commons.log("Increasing Value of Cell By",j,a.Commons.validLogKeys.correctionLogKey)):(j=a.Commons.randomizePlusMinusControlled(1,k,1,10,15),a.Commons.log("Decreasing Value of Cell By",j,a.Commons.validLogKeys.correctionLogKey)),b+=j}}return b},A=function(c){var d,e=E(c),f=a.Commons.getMainTerrains(b);for(d in e)if(e[d].isRegularTerrain()===!0){terrainKey=e[d].getData().terrainKey;break}var g=a.Commons.getTerrainByKey(f,terrainKey);if(g){var h=!1;for(d in k)k[d].terrainKey===g.terrainKey?(k[d].increment(),h=k[d]):k[d].pass();if(h)return z(c,g,h)}return a.Commons.warn("Unable to find Regular Terrain for the Given Cell Value"),c},B=function(b,c){a.Commons.info("Diamond Step Starting"),C(b/2,b/2,b,c),a.Commons.info("Square Step Starting"),D(b/2,b/2,b,c)},C=function(b,d,e,f){var g=Math.floor(e/2),h=Math.floor(g/2);a.Commons.log("HalfBoxSize",g,a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("QuarterBoxSize",h,a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("Getting Average of",["["+(b-g)+"],["+(d-g)+"]","["+(b-g)+"],["+(d+g)+"]","["+(b+g)+"],["+(d-g)+"]","["+(b+g)+"],["+(d+g)+"]"],a.Commons.validLogKeys.diamondSquareLogKey),c[b][d]=a.Commons.getAverage([c[b-g][d-g],c[b-g][d+g],c[b+g][d-g],c[b+g][d+g]]),c[b][d]=A(c[b][d]),a.Commons.log("Value of Center ["+b+"]["+d+"]",c[b][d],a.Commons.validLogKeys.diamondSquareLogKey),g>=2&&(C(b-h,d-h,g,f),C(b+h,d-h,g,f),C(b-h,d+h,g,f),C(b+h,d+h,g,f))},D=function(b,d,e,f){var g=Math.floor(e/2),h=Math.floor(g/2);a.Commons.log("HalfBoxSize",g,a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("QuarterBoxSize",h,a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("Getting Average of",["["+(b-g)+"],["+(d-g)+"]","["+b+"],["+d+"]","["+(b-g)+"],["+(d+g)+"]","["+(b-e)+"],["+d+"]"],a.Commons.validLogKeys.diamondSquareLogKey),c[b-g][d]=a.Commons.getAverage([a.Commons.tryGetArrayValue(c,b-g,d-g),a.Commons.tryGetArrayValue(c,b,d),a.Commons.tryGetArrayValue(c,b-g,d+g),a.Commons.tryGetArrayValue(c,b-e,d)])+a.Commons.randomizePlusMinus(0,5),c[b-g][d]=A(c[b-g][d]),a.Commons.log("Value of ["+(b-g)+"]["+d+"]",c[b-g][d],a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("Getting Average of",["["+(b+g)+"],["+(d-g)+"]","["+b+"],["+d+"]","["+(b+g)+"],["+(d+g)+"]","["+(b+e)+"],["+d+"]"],a.Commons.validLogKeys.diamondSquareLogKey),c[b+g][d]=a.Commons.getAverage([a.Commons.tryGetArrayValue(c,b+g,d-g),a.Commons.tryGetArrayValue(c,b,d),a.Commons.tryGetArrayValue(c,b+g,d+g),a.Commons.tryGetArrayValue(c,b+e,d)])+a.Commons.randomizePlusMinus(0,5),c[b+g][d]=A(c[b+g][d]),a.Commons.log("Value of ["+(b+g)+"]["+d+"]",c[b+g][d]),a.Commons.log("Getting Average of",["["+(b-g)+"],["+(d-g)+"]","["+b+"],["+d+"]","["+(b+g)+"],["+(d-g)+"]","["+b+"],["+(d-e)+"]"],a.Commons.validLogKeys.diamondSquareLogKey),c[b][d-g]=a.Commons.getAverage([a.Commons.tryGetArrayValue(c,b-g,d-g),a.Commons.tryGetArrayValue(c,b,d),a.Commons.tryGetArrayValue(c,b+g,d-g),a.Commons.tryGetArrayValue(c,b,d-e)])+a.Commons.randomizePlusMinus(0,5),c[b][d-g]=A(c[b][d-g]),a.Commons.log("Value of ["+b+"]["+(d-g)+"]",c[b][d-g],a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("Getting Average of",["["+(b-g)+"],["+(d+g)+"]","["+b+"],["+d+"]","["+(b+g)+"],["+(d+g)+"]","["+b+"],["+(d+e)+"]"],a.Commons.validLogKeys.diamondSquareLogKey),c[b][d+g]=a.Commons.getAverage([a.Commons.tryGetArrayValue(c,b-g,d+g),a.Commons.tryGetArrayValue(c,b,d),a.Commons.tryGetArrayValue(c,b+g,d+g),a.Commons.tryGetArrayValue(c,b,d+e)])+a.Commons.randomizePlusMinus(0,5),c[b][d+g]=A(c[b][d+g]),a.Commons.log("Value of ["+b+"]["+(d+g)+"]",c[b][d+g],a.Commons.validLogKeys.diamondSquareLogKey),g>=2&&(D(b-h,d-h,g,f),D(b+h,d-h,g,f),D(b-h,d+h,g,f),D(b+h,d+h,g,f))},E=function(a){var c=[];for(var d in b)b[d].getData().terrainUpperValue>=a&&b[d].getData().terrainLowerValue<=a&&c.push(b[d]);return c},F=function(){for(var a in c){var b=[];for(var e in c[a]){var f=E(c[a][e]);for(var g in f)if(f[g].isRegularTerrain()===!0){terrainKey=f[g].getData().terrainKey;break}b.push(terrainKey)}d.push(b)}return d},G=function(a,b){return a.getDecorationData().zLevel-b.getDecorationData().zLevel},H=function(){var b,d;for(var f in c){var g=[];for(var h in c[f]){var i=E(c[f][h]),j=[],k=[],l=[];for(var m in i)i[m].isDecorationTerrain()===!0&&i[m].getDecorationData().overlap===!1?j.push(i[m]):i[m].isDecorationTerrain()===!0&&i[m].getDecorationData().overlap===!0&&k.push(i[m]);a.Commons.log("Before Sort - Overlapping Decoration",k,a.Commons.validLogKeys.decorationRenderLogKey),a.Commons.log("Before Sort - Non-Overlapping Decoration",j,a.Commons.validLogKeys.decorationRenderLogKey),k.sort(G),j.sort(G),a.Commons.log("After Sort - Overlapping Decoration",k,a.Commons.validLogKeys.decorationRenderLogKey),a.Commons.log("After Sort - Non-Overlapping Decoration",j,a.Commons.validLogKeys.decorationRenderLogKey);var n=0,o=100*j.length;for(b in j)n+=j[b].getDecorationData().placementPercent;if(n>o){a.Commons.warn("Error Adding Placement Percentage of Decoration Terrains - Reverting Terrains to 100% per terrain"),n=100*j.length;for(b in j)j[b].getDecorationData().placementPercent=100}a.Commons.log("totalPercent",n,a.Commons.validLogKeys.decorationRenderLogKey);var p=a.Commons.randomize(0,o),q=null,r=0;a.Commons.log("maxValuePossible",o,a.Commons.validLogKeys.decorationRenderLogKey),a.Commons.log("randomPercent",p,a.Commons.validLogKeys.decorationRenderLogKey);for(b in j)if(r+=j[b].getDecorationData().placementPercent,r>=p){q=j[b];break}q&&(l.push(q),a.Commons.log("Pushing",q,a.Commons.validLogKeys.decorationRenderLogKey));for(d in k)p=a.Commons.randomize(0,100),p<=k[d].getDecorationData().placementPercent&&(l.push(k[d]),a.Commons.log("Pushing",k[d],a.Commons.validLogKeys.decorationRenderLogKey));g.push(l)}e.push(g)}return e};this.setDimensions=function(a,b){l=a,m=b},this.addTerrain=function(c){var d=new a.ScaledTerrain;d.createTerrain(c.label,c.key,c.max,c.min),"type"in c&&(-1!==s.indexOf(c.type)?d.setType(c.type):a.Commons.error("Error Adding Terrain Type : "+c.type)),"default"in c&&o===!1&&(o=!0,d.setDefault()),a.Commons.log("Adding Terrain",d.getData(),a.Commons.validLogKeys.mapInitializeLogKey),b.push(d)},this.addStartingCondition=function(c){var d=a.Commons.getTerrainByKey(b,c.terrainKey);d.setStartingCondition(c.minCount,c.optionalPercent)},this.addValidationRule=function(c){var d=c.terrainKey,e=-1,f=-1;if("minPercent"in c&&(e=c.minPercent),"maxPercent"in c&&(f=c.maxPercent),f=0>f?-1:f,e=0>e?-1:e,e>f&&-1!==f&&-1!==e){a.Commons.warn("Terrain ("+d+") Validation minPercent is more than its maxPercent, Swapping Values");var g=e;e=f,f=g}a.Commons.getTerrainByKey(b,d).setValidation(e,f)},this.setTileInfo=function(c){var d=c.terrainKey,e=c.tiles,f=c.decoration?c.decoration:!1;a.Commons.getTerrainByKey(b,d).setTileInfo(e),a.Commons.getTerrainByKey(b,d).setDecorationData(f)},this.checkRegularTerrainValidity=function(){var c=a.Commons.getMainTerrains(b),d=!0;for(var e in c){var g=t(c[e].terrainKey),h=null;-1!=c[e].terrainValidationMinPercent&&g<c[e].terrainValidationMinPercent&&(d=!1,h=new a.ScaledValidityReport(c[e].terrainKey,Math.abs(g-c[e].terrainValidationMinPercent),!0)),-1!=c[e].terrainValidationMaxPercent&&g>c[e].terrainValidationMaxPercent&&(d=!1,h=new a.ScaledValidityReport(c[e].terrainKey,Math.abs(g-c[e].terrainValidationMaxPercent),!1)),null!==h&&f.push(h)}return a.Commons.log("Validity Reports",f,a.Commons.validLogKeys.mapValidationLogKey),d},this.getRegularTerrainPercentages=function(){var c={},d=a.Commons.getMainTerrains(b);for(var e in d){var f=t(d[e].terrainKey);c[d[e].terrainKey]=f}return c},this.generateMapValues=function(){a.Commons.info("Map Init Starting"),a.Commons.log("Terrains Before Map Generation",b,a.Commons.validLogKeys.mapInitializeLogKey),u(),w(),a.Commons.info("Pre Generation Clean Up"),y(),a.Commons.info("Diamond Square Algorithm Starting"),B(l-1,null),a.Commons.info("Post Generation Clean Up"),x()},this.getLayersFromValue=function(a){return E(a)},this.getTmxSettings=function(){F(),H();var a={mapValues:d,terrains:b,mapValuesDecoration:e};return a},this.getMapValues=function(){return c}};return a.ScaledMap=b,a}(Scaled||{}),Scaled=function(a){var b=function(){this.terrainKey=-1;var b=-1,c=-1,d=-1,e=-1,f="terrain",g=!1,h=0,i=0,j=-1,k=-1,l=-1,m=!1;this.createTerrain=function(a,e,f,g){this.terrainKey=e,b=f,c=g,d=a},this.setStartingCondition=function(a,b){i=b,h=a},this.setDefault=function(){g=!0},this.setType=function(a){f=a},this.getRandomTerrainValue=function(){return a.Commons.randomize(c,b)},this.isRegularTerrain=function(){return"terrain"==f?!0:!1},this.isDecorationTerrain=function(){return"decoration"==f?!0:!1},this.setValidation=function(a,b){j=a,k=b},this.setDecorationData=function(a){a.placementPercent=a.placementPercent?a.placementPercent:0,a.overlap=a.overlap?a.overlap:!1,a.zLevel=a.zLevel?a.zLevel:0,a.edgePlacement=a.edgePlacement?a.edgePlacement:!1,m=a},this.getDecorationData=function(){return m},this.setTileInfo=function(a){l=a},this.getTiles=function(){return l},this.getTileData=function(b,c,e){var f=this.getTiles(),g=!1;for(var h in f)if(f[h].type==b&&f[h].placement==c){g=f[h];break}return g&&g[e]?g[e]:(a.Commons.error("Can't Find Tile Information for Layer: "+d+", Tile Data: "+b+", "+c+", "+e),!1)},this.getData=function(){var a={terrainKey:this.terrainKey,terrainUpperValue:b,terrainLowerValue:c,terrainLabel:d,terrainZLevel:e,terrainType:f,terrainDefault:g,terrainStartCount:h,terrainStartPercent:i,terrainValidationMinPercent:j,terrainValidationMaxPercent:k,terrainTileInfo:l};return a}};return a.ScaledTerrain=b,a}(Scaled||{}),Scaled=function(a){var b=function(b){var c=1,d="",e=[],f=[],g=[],h=[],i=null,j=null,k=null,l=null;b&&(f=b.mapValues?b.mapValues:[],e=b.terrains?b.terrains:[],i=b.tilesetSettings?b.tilesetSettings:null,l=b.domSettings?b.domSettings:null,g=b.mapValuesDecoration?b.mapValuesDecoration:[]),k={terrains:e,domination:l},j=new a.ScaledEdgeDetector(k);var m=function(b,c){var d=[];return b=parseInt(b),c=parseInt(c),d.push(a.Commons.tryGetArrayValue(f,b-1,c)),d.push(a.Commons.tryGetArrayValue(f,b,c+1)),d.push(a.Commons.tryGetArrayValue(f,b+1,c)),d.push(a.Commons.tryGetArrayValue(f,b,c-1)),d},n=function(b,c){var d=[];return b=parseInt(b),c=parseInt(c),d.push(a.Commons.tryGetArrayValue(f,b-1,c-1)),d.push(a.Commons.tryGetArrayValue(f,b-1,c+1)),d.push(a.Commons.tryGetArrayValue(f,b+1,c+1)),d.push(a.Commons.tryGetArrayValue(f,b+1,c-1)),d},o=function(){var a=[];for(var b in f){var d=[];for(var e in f[b])d.push(c);a.push(d)}h.push(a)},p=function(){var b=a.Commons.getDefaultTerrain(e).getTileData("other-tiles","all","fullValue"),c=[];for(var d in f){var g=[];for(var i in f[d])g.push(b);c.push(g)}h.push(c)},q=function(a,b,c){for(var d in h)if(h[d][b][c]==a)return!0;return!1},r=function(a,b){for(var d in h)if(h[d][a][b]===c)return d;return-1},s=function(a,b,c){1===h.length&&o(),b=parseInt(b),c=parseInt(c);for(var d in a){var e=a[d];if(q(e,b,c)===!1){var f=r(b,c);if(-1!==f)h[f][b][c]=e;else{var g=h.length;o(),h[g][b][c]=e}}}},t=function(a){d+='<layer name="layer_'+a+'" width="'+h[0].length+'" height="'+h[0].length+'">',d+="<data>"},u=function(){d+="</data>",d+="</layer>"},v=function(a){d+='<tile gid="'+a+'" />'},w=function(b){var c,d,e=b.getData().terrainTileInfo,f=0,g=0,h=null;for(c in e)e[c].weight&&(f+=e[c].weight);d=a.Commons.randomize(0,f);for(c in e)if(g+=e[c].weight,g>=d){h=e[c];break}return h&&!h.dimensions?h.value:-1},x=function(a,b){var c=f[a][b],d=j.getAdjacentSimilarity(c,m(a,b));return j.allSquareSidesSimilar(d)===!0?!0:!1},y=function(){for(var b in f)for(var c in f[b])if(g[b]){var d=g[b][c],e=[],h=x(b,c);if(d&&0!==d.length){for(var i in d)(h||d[i].getDecorationData().edgePlacement)&&e.push(w(d[i]));a.Commons.removeKeyFromArray(e,-1)}e&&e.length>0&&s(e,b,c)}};this.generateMapTmx=function(){a.Commons.info("TMX - Generating Layered Map"),this.generateLayeredMap(),a.Commons.info("TMX - Decorating Map"),y(),a.Commons.info("TMX - Generating Map XML"),this.generateMapXml()},this.generateMapLayered=function(){a.Commons.info("TMX - Generating Layered Map"),this.generateLayeredMap(),a.Commons.info("TMX - Decorating Map"),y()},this.getTmxXml=function(){return d},this.getLayeredMap=function(){return h},this.generateLayeredMap=function(){p();for(var b in f)for(var c in f[b]){a.Commons.log("Primary Pos",b+","+c,a.Commons.validLogKeys.tmxRenderLogKey);var d=m(b,c),e=n(b,c),g=j.resolveTileValue(f[b][c],d,e);s(g,b,c)}},this.generateMapXml=function(){d+='<?xml version="1.0" encoding="UTF-8"?>',d+='<map version="1.0" orientation="orthogonal" renderorder="left-up" width="'+h[0].length+'" height="'+h[0].length+'" tilewidth="'+i.tileWidth+'" tileheight="'+i.tileHeight+'" nextobjectid="1">',d+='<tileset firstgid="1" name="tileset" tilewidth="'+i.tileWidth+'" tileheight="'+i.tileHeight+'">',d+='<image source="'+i.source+'" trans="ffffff" width="'+i.width+'" height="'+i.height+'"/>',d+="</tileset>";for(var a in h){t(a);for(var b in h[a])for(var c in h[a][b])v(h[a][b][c]);u()}d+="</map>"}};return a.ScaledTmxGen=b,a}(Scaled||{}),Scaled=function(a){var b=function(a,b,c){this.terrainKey=a,this.repairMagnitude=b,this.positiveIncrease=c};return a.ScaledValidityReport=b,a}(Scaled||{});