function ScaledGen(a){var b=10,c=new ScaledMap;a&&("debug"in a&&a.debug===!0&&(Commons.debug=!0),"logs"in a&&(Commons.allowedLogs=a.logs),"maxTries"in a&&(b=a.maxTries),"onProgressUpdate"in a&&(Commons.showProgressUpdate=a.onProgressUpdate)),this.GetMapValues=function(){return c.mapValues},this.SetMapSize=function(a,b){c.rowSize=a,c.columnSize=b},this.AddTerrain=function(a){c.AddTerrain(a)},this.AddStartingCondition=function(a){c.AddStartingCondition(a)},this.AddValidationRule=function(a){c.AddValidationRule(a)},this.GenerateMap=function(){var a=!1,d=0;do c.GenerateMapValues(),a=c.CheckRegularTerrainValidity(),d++;while(a===!1&&b>d);a===!1&&Commons.Error("Unable to Validate Map. Perhaps Conditions set are too Strict.")},this.RenderMapValues=function(a){var b=document.getElementById(a);b.innerHTML="";var e=c.GetMapValues(),f="";for(var g in e)f+=d(e[g]);b.innerHTML=f};var d=function(a){var b="<div class='row'>";for(var c in a)b+=e(a[c]);return b+="</div>"},e=function(a){var b=c.GetLayersFromValue(a);Commons.Log("Terrains For Cell Value : "+a,b,Commons.validLogKeys.mapRenderLogKey);var d="no-cell";for(var e in b)if(b[e].IsRegularTerrain()===!0){d=b[e].getData().terrainKey;break}var f="";return f+="<div class='cell "+d+" ",f+="data-value='"+a+"' ",f+="'>",f+="</div>"}}var Commons={debug:!1,allowedLogs:["all"],validLogKeys:{mapInitializeLogKey:"mapInit",diamondSquareLogKey:"diamondSquare",mapValidationLogKey:"mapValidation",mapRenderLogKey:"mapRender"},showProgressUpdate:function(){}},PLUS_MINUS_BAR=4;Commons.ConsoleLog=function(a,b){this.debug===!0},Commons.Log=function(a,b,c){this.debug!==!0||-1==this.allowedLogs.indexOf(c)&&"all"!=this.allowedLogs[0]||this.ConsoleLog(a,b)},Commons.Warn=function(a){this.debug===!0},Commons.Error=function(a){this.debug===!0},Commons.RoundNumber=function(a){return Math.round(a)},Commons.Randomize=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},Commons.RandomizeInArray=function(a){var b=0,c=a.length-1,d=this.Randomize(b,c);return a[d]},Commons.RandomizeWithException=function(a,b,c){var d=-1;do d=this.Randomize(a,b);while(-1!=c.indexOf(d));return d},Commons.RandomizePlusMinus=function(a,b){{var c=this.Randomize(1,10);this.Randomize(a,b)}return PLUS_MINUS_BAR>=c?-1*c:c},Commons.GetAverage=function(a){this.Log("Array Came",a);var b=0,c=0;for(var d in a)-1!=a[d]&&(b+=a[d],c++);var e=b/c;return this.Log("Avg",e),e},Commons.TryGetArrayValue=function(a,b,c){return b in a&&c in a[b]?a[b][c]:-1};var ScaledMap=function(){var a=[],b=[],c=[],d=33,e=33,f=-1,g=!1,h=["","","",""],k=[],l=!1,m=function(){var b=[];for(var c in a)"terrain"==a[c].getData().terrainType&&b.push(a[c].getData());return b},n=function(b){for(var c in a)if(a[c].terrainKey==b)return a[c]},o=function(a){var c=0,f=d*e,g=n(a);for(var h in b)for(var i in b)b[h][i]<=g.terrainUpperValue&&b[h][i]>=g.terrainLowerValue&&c++;var j=c/f*100;return Commons.Log(g.terrainKey+" Percentage of Terrain",j,Commons.validLogKeys.mapValidationLogKey),j},p=function(){if(l===!1){for(g===!1&&a[0].SetDefault(),i=0;i<d;i++){var c=[];for(j=0;j<e;j++)c.push(f);b.push(c)}Commons.Log("Map Values Empty",b,Commons.validLogKeys.mapInitializeLogKey),l=!0}},q=function(){h=["","","",""],k=[];var a=[],c=0,f=m();Commons.Log("Regular Terrains",f,Commons.validLogKeys.mapInitializeLogKey);for(var g in f)if(f[g].terrainStartCount>0){var l={};l.terrainKey=f[g].terrainKey,l.count=f[g].terrainStartCount,l.nextPercent=f[g].terrainStartPercent,c+=f[g].terrainStartCount,a.push(l)}a.sort(function(a,b){return b.count-a.count});var o=4,p=[];if(4>=c){o=4-c;for(var q in a)for(j=0;j<a[q].count;j++){var r=Commons.RandomizeWithException(0,3,p);p.push(r),h[r]=a[q].terrainKey}}if(Commons.Log("Empty Non Optional Slots to Use",o,Commons.validLogKeys.mapInitializeLogKey),0!==o){var s=0,t=[],u=[];for(var v in f){var w={};f[v].terrainStartPercent>0?(s+=f[v].terrainStartPercent,w.terrainKey=f[v].terrainKey,w.cumulativePercent=s,t.push(w)):(w.terrainKey=f[v].terrainKey,u.push(w))}if(s>100);else for(i=0;i<o;i++){var x=Commons.RandomizeWithException(0,3,p);p.push(x);var y=Commons.Randomize(0,100),z=null,A=!1;for(var B in t)if(y<=t[B].cumulativePercent){A=!0,z=t[B].terrainKey;break}A===!1&&(z=Commons.RandomizeInArray(u).terrainKey),h[x]=z}}Commons.Log("Start Terrain Keys",h,Commons.validLogKeys.mapInitializeLogKey);for(var C in h){var D=n(h[C]);k.push(D.GetRandomTerrainValue())}Commons.Log("Start Terrain Values",k,Commons.validLogKeys.mapInitializeLogKey),b[0][0]=k[0],b[0][e-1]=k[1],b[d-1][0]=k[2],b[d-1][e-1]=k[3],Commons.Log("Map Values After Starting Values",b,Commons.validLogKeys.mapInitializeLogKey)},r=function(){for(var a in b)for(var d in b)b[a][d]<0&&(b[a][d]=0),b[a][d]>100&&(b[a][d]=100);c=[]},s=function(){0!==c.length},t=function(a,b){Commons.Warn("Diamond Step Starting"),u(a/2,a/2,a,b),Commons.Warn("Square Step Starting"),v(a/2,a/2,a,b)},u=function(a,c,d,e){var f=Math.floor(d/2),g=Math.floor(f/2);Commons.Log("HalfBoxSize",f,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("QuarterBoxSize",g,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Average of",["["+(a-f)+"],["+(c-f)+"]","["+(a-f)+"],["+(c+f)+"]","["+(a+f)+"],["+(c-f)+"]","["+(a+f)+"],["+(c+f)+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a][c]=Commons.GetAverage([b[a-f][c-f],b[a-f][c+f],b[a+f][c-f],b[a+f][c+f]]),Commons.Log("Value of Center ["+a+"]["+c+"]",b[a][c],Commons.validLogKeys.diamondSquareLogKey),f>=2&&(u(a-g,c-g,f,e),u(a+g,c-g,f,e),u(a-g,c+g,f,e),u(a+g,c+g,f,e))},v=function(a,c,d,e){var f=Math.floor(d/2),g=Math.floor(f/2);Commons.Log("HalfBoxSize",f,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("QuarterBoxSize",g,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Average of",["["+(a-f)+"],["+(c-f)+"]","["+a+"],["+c+"]","["+(a-f)+"],["+(c+f)+"]","["+(a-d)+"],["+c+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a-f][c]=Commons.GetAverage([Commons.TryGetArrayValue(b,a-f,c-f),Commons.TryGetArrayValue(b,a,c),Commons.TryGetArrayValue(b,a-f,c+f),Commons.TryGetArrayValue(b,a-d,c)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+(a-f)+"]["+c+"]",b[a-f][c],Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Average of",["["+(a+f)+"],["+(c-f)+"]","["+a+"],["+c+"]","["+(a+f)+"],["+(c+f)+"]","["+(a+d)+"],["+c+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a+f][c]=Commons.GetAverage([Commons.TryGetArrayValue(b,a+f,c-f),Commons.TryGetArrayValue(b,a,c),Commons.TryGetArrayValue(b,a+f,c+f),Commons.TryGetArrayValue(b,a+d,c)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+(a+f)+"]["+c+"]",b[a+f][c]),Commons.Log("Getting Average of",["["+(a-f)+"],["+(c-f)+"]","["+a+"],["+c+"]","["+(a+f)+"],["+(c-f)+"]","["+a+"],["+(c-d)+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a][c-f]=Commons.GetAverage([Commons.TryGetArrayValue(b,a-f,c-f),Commons.TryGetArrayValue(b,a,c),Commons.TryGetArrayValue(b,a+f,c-f),Commons.TryGetArrayValue(b,a,c-d)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+a+"]["+(c-f)+"]",b[a][c-f],Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Average of",["["+(a-f)+"],["+(c+f)+"]","["+a+"],["+c+"]","["+(a+f)+"],["+(c+f)+"]","["+a+"],["+(c+d)+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a][c+f]=Commons.GetAverage([Commons.TryGetArrayValue(b,a-f,c+f),Commons.TryGetArrayValue(b,a,c),Commons.TryGetArrayValue(b,a+f,c+f),Commons.TryGetArrayValue(b,a,c+d)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+a+"]["+(c+f)+"]",b[a][c+f],Commons.validLogKeys.diamondSquareLogKey),f>=2&&(v(a-g,c-g,f,e),v(a+g,c-g,f,e),v(a-g,c+g,f,e),v(a+g,c+g,f,e))};this.SetDimensions=function(a,b){d=a,e=b},this.AddTerrain=function(b){var c=new ScaledTerrain;"zLevel"in b?c.CreateTerrain(b.label,b.key,b.max,b.min,b.zLevel):c.CreateTerrain(b.label,b.key,b.max,b.min,0),"type"in b&&c.SetType(b.type),"default"in b&&g===!1&&(g=!0,c.SetDefault()),Commons.Log("Adding Terrain",c.getData(),Commons.validLogKeys.mapInitializeLogKey),a.push(c)},this.AddStartingCondition=function(a){var b=n(a.terrainKey);b.SetStartingCondition(a.minCount,a.optionalPercent)},this.AddValidationRule=function(a){var b=a.terrainKey,c=-1,d=-1;"minPercent"in a&&(c=a.minPercent),"maxPercent"in a&&(d=a.maxPercent),n(b).SetValidation(c,d)},this.CheckRegularTerrainValidity=function(){var a=m(),b=!0;for(var d in a){var e=o(a[d].terrainKey),f=null;-1!=a[d].terrainValidationMinPercent&&e<a[d].terrainValidationMinPercent&&(b=!1,f=new ScaledValidityReport(a[d].terrainKey,Math.abs(e-a[d].terrainValidationMinPercent),!0)),-1!=a[d].terrainValidationMaxPercent&&e>a[d].terrainValidationMaxPercent&&(b=!1,f=new ScaledValidityReport(a[d].terrainKey,Math.abs(e-a[d].terrainValidationMaxPercent),!1)),null!==f&&c.push(f)}return Commons.Log("Validity Reports",c,Commons.validLogKeys.mapValidationLogKey),b},this.GenerateMapValues=function(){Commons.Warn("Map Init Starting"),Commons.Log("Terrains Before Map Generation",a,Commons.validLogKeys.mapInitializeLogKey),p(),q(),s(),Commons.Warn("Diamond Square Algorithm Starting"),t(d-1,null),r()},this.GetLayersFromValue=function(b){var c=[];for(var d in a)a[d].getData().terrainUpperValue>=b&&a[d].getData().terrainLowerValue<=b&&c.push(a[d]);return c},this.GetMapValues=function(){return b}},ScaledTerrain=function(){this.terrainKey=-1;var a=-1,b=-1,c=-1,d=-1,e="terrain",f=!1,g=0,h=0,i=-1,j=-1;this.CreateTerrain=function(e,f,g,h,i){this.terrainKey=f,a=g,b=h,c=e,d=i},this.SetStartingCondition=function(a,b){h=b,g=a},this.SetDefault=function(){f=!0},this.SetType=function(a){e=a},this.GetRandomTerrainValue=function(){return Commons.Randomize(b,a)},this.IsRegularTerrain=function(){return"terrain"==e?!0:!1},this.SetValidation=function(a,b){this.terrainValidationMinPercent=a,this.terrainValidationMaxPercent=b},this.getData=function(){var k={terrainKey:this.terrainKey,terrainUpperValue:a,terrainLowerValue:b,terrainLabel:c,terrainZLevel:d,terrainType:e,terrainDefault:f,terrainStartCount:g,terrainStartPercent:h,terrainValidationMinPercent:i,terrainValidationMaxPercent:j};return k}},ScaledValidityReport=function(a,b,c){this.terrainKey=a,this.repairMagnitude=b,this.positiveIncrease=c},ScaledAutoReview=function(a,b){this.terrain=a,this.validityReport=b};