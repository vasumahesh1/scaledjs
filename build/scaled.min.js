function ScaledGen(a){var b=10,c=new ScaledMap,d=null,e=null,f=null;a&&("debug"in a&&a.debug===!0&&(Commons.debug=!0),"logs"in a&&(Commons.allowedLogs=a.logs),"maxTries"in a&&(b=a.maxTries),"onProgressUpdate"in a&&(Commons.showProgressUpdate=a.onProgressUpdate)),this.getMapValues=function(){return c.getMapValues()},this.setMapSize=function(a,b){c.setDimensions(a,b)},this.addTerrain=function(a){c.addTerrain(a)},this.addStartingCondition=function(a){c.addStartingCondition(a)},this.addValidationRule=function(a){c.addValidationRule(a)},this.addLayerDomination=function(a){e=a},this.addTileset=function(a){f=a},this.setTileInfo=function(a){c.setTileInfo(a)},this.generateMapValues=function(){var a=!1,d=0;do c.generateMapValues(),a=c.checkRegularTerrainValidity(),d++;while(a===!1&&b>d);a===!1&&Commons.error("Unable to Validate Map. Perhaps Conditions set are too Strict.")},this.generateMap=function(){if(this.generateMapValues(),e&&f){var a=c.getTmxSettings();a.domSettings=e,a.tilesetSettings=f,d=new ScaledTmxGen(a),d.generateMapTmx()}else Commons.warn("No Domination Settings / TileSet Settings provided skipping TMX Generation")},this.getTmxXml=function(){return d.getTmxXml()},this.renderMapValues=function(a){var b=document.getElementById(a);b.innerHTML="";var d=c.getMapValues(),e="";for(var f in d)e+=g(d[f]);b.innerHTML=e};var g=function(a){var b="<div class='row'>";for(var c in a)b+=h(a[c]);return b+="</div>"},h=function(a){var b=c.getLayersFromValue(a);Commons.log("Terrains For Cell Value : "+a,b,Commons.validLogKeys.mapRenderLogKey);var d="no-cell";for(var e in b)if(b[e].isRegularTerrain()===!0){d=b[e].getData().terrainKey;break}var f="";return f+="<div class='cell "+d+" ",f+="data-value='"+a+"' ",f+="'>",f+="</div>"}}var root="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=ScaledGen),exports.ScaledGen=ScaledGen):root.ScaledGen=ScaledGen;var Commons={debug:!1,allowedLogs:["all"],validLogKeys:{mapInitializeLogKey:"mapInit",diamondSquareLogKey:"diamondSquare",mapValidationLogKey:"mapValidation",mapRenderLogKey:"mapRender",tmxRenderLogKey:"tmxRender"},showProgressUpdate:function(){}},PLUS_MINUS_BAR=4;Commons.consoleLog=function(a,b){this.debug===!0},Commons.log=function(a,b,c){this.debug!==!0||-1==this.allowedLogs.indexOf(c)&&"all"!=this.allowedLogs[0]||this.consoleLog(a,b)},Commons.warn=function(a){this.debug===!0},Commons.info=function(a){this.debug===!0},Commons.error=function(a){this.debug===!0},Commons.roundNumber=function(a){return Math.round(a)},Commons.randomize=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},Commons.randomizeInArray=function(a){var b=0,c=a.length-1,d=this.randomize(b,c);return a[d]},Commons.randomizeWithException=function(a,b,c){var d=-1;do d=this.randomize(a,b);while(-1!=c.indexOf(d));return d},Commons.randomizePlusMinus=function(a,b){{var c=this.randomize(1,10);this.randomize(a,b)}return PLUS_MINUS_BAR>=c?-1*c:c},Commons.getAverage=function(a){this.log("Array Came",a);var b=0,c=0;for(var d in a)-1!=a[d]&&(b+=a[d],c++);var e=b/c;return this.log("Avg",e),e},Commons.tryGetArrayValue=function(a,b,c){return b in a&&c in a[b]?a[b][c]:-1},Commons.isPointAtEdge=function(a,b,c){return b=parseInt(b),c=parseInt(c),0===b||0===c?!0:b==a.length||c==a[0].length?!0:!1},Commons.getDefaultTerrain=function(a){for(var b in a)if(a[b].getData().terrainDefault===!0)return a[b]},Commons.getMainTerrains=function(a){var b=[];for(var c in a)a[c].isRegularTerrain()===!0&&b.push(a[c].getData());return b},Commons.removeKeyFromArray=function(a,b){for(var c in a)a[c]===b&&a.splice(c,1)},Commons.getDecorationTerrains=function(a){var b=[];for(var c in a)a[c].isDecorationTerrain()===!0&&b.push(a[c].getData());return b},Commons.getTerrainByKey=function(a,b){for(var c in a)if(a[c].terrainKey==b)return a[c]},Commons.getTerrainMaximum=function(a){var b=-1,c=null;for(var d in a)a[d].isRegularTerrain()===!0&&a[d].getData().terrainUpperValue>b&&(b=a[d].getData().terrainUpperValue,c=a[d]);return c},Commons.getTerrainMinimum=function(a){var b=101,c=null;for(var d in a)a[d].isRegularTerrain()===!0&&a[d].getData().terrainLowerValue<b&&(b=a[d].getData().terrainLowerValue,c=a[d]);return c};var ScaledEdgeDetector=function(a){var b=a.terrains,c=a.domination,d=c.dominationPriority,e=function(a){return d.indexOf(a)},f=function(a){return d[a]},g=function(a,b){return a-b},h=function(a){for(var b={},c=[],d=0,e=a.length;e>d;++d)b.hasOwnProperty(a[d])||(c.push(a[d]),b[a[d]]=1);return c},i=function(a,b){var c=[];for(var d in b)c.push(-1!==b[d]&&e(b[d])<e(a)?b[d]:a);return c},j=function(a,b){var c,d=[],i=e(a);for(var j in b)if(-1!==b[j]){var k=e(b[j]);d.push(k)}Commons.log("Primary Value",a,Commons.validLogKeys.tmxRenderLogKey),Commons.log("Surroundings",b,Commons.validLogKeys.tmxRenderLogKey),Commons.log("Before Unique",d,Commons.validLogKeys.tmxRenderLogKey),d=h(d),Commons.log("After Unique",d,Commons.validLogKeys.tmxRenderLogKey),d.sort(g);var l=Math.min.apply(null,d);if(l==i)c=i;else{var m=d.indexOf(i);c=0!==m&&-1!=m?d[m-1]:d[0]}return Commons.log("Returning",f(c),Commons.validLogKeys.tmxRenderLogKey),f(c)};this.allSquareSidesSimilar=function(a){return a.top===!0&&a.left===!0&&a.right===!0&&a.bottom===!0?!0:!1},this.getDiagonalSimilarity=function(a,b){var c={topLeft:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,count:0};return b[0]==a&&(c.topLeft=!0,c.count++),b[1]==a&&(c.topRight=!0,c.count++),b[2]==a&&(c.bottomRight=!0,c.count++),b[3]==a&&(c.bottomLeft=!0,c.count++),c},this.getAdjacentSimilarity=function(a,b){var c={top:!1,left:!1,right:!1,bottom:!1,count:0};return b[0]==a&&(c.top=!0,c.count++),b[1]==a&&(c.right=!0,c.count++),b[2]==a&&(c.bottom=!0,c.count++),b[3]==a&&(c.left=!0,c.count++),c},this.resolveTileValue=function(a,c,d){if(Commons.getDefaultTerrain(b).terrainKey==a)return[];Commons.log("Primary Cell Layer",a,Commons.validLogKeys.tmxRenderLogKey),Commons.log("Adjacent Values",c,Commons.validLogKeys.tmxRenderLogKey),Commons.log("Diagonal Values",d,Commons.validLogKeys.tmxRenderLogKey);var e=[],f=Commons.getTerrainByKey(b,a),g=j(a,c);Commons.log("Lowest Domination",g,Commons.validLogKeys.tmxRenderLogKey);var h=Commons.getTerrainByKey(b,g).getTileData("other-tiles","all","fullValue");e.push(h);var k=i(a,c),l=i(a,d),m=this.getAdjacentSimilarity(a,k),n=this.getDiagonalSimilarity(a,l);return Commons.log("Similarity",m,Commons.validLogKeys.tmxRenderLogKey),this.allSquareSidesSimilar(m)===!0?e.push(f.getTileData("other-tiles","all","fullValue")):0===m.count?e.push(f.getTileData("open-tiles","open","noneValue")):m.top===!0&&m.left===!0&&m.right===!0?e.push(f.getTileData("enclosing-tiles","top","topValue")):m.bottom===!0&&m.left===!0&&m.right===!0?e.push(f.getTileData("enclosing-tiles","bottom","bottomValue")):m.top===!0&&m.bottom===!0&&m.right===!0?e.push(f.getTileData("enclosing-tiles","right","rightValue")):m.top===!0&&m.bottom===!0&&m.left===!0?e.push(f.getTileData("enclosing-tiles","left","leftValue")):m.top===!0&&m.left===!0?e.push(f.getTileData("excluding-tiles","bottom","rightValue")):m.top===!0&&m.right===!0?e.push(f.getTileData("excluding-tiles","bottom","leftValue")):m.bottom===!0&&m.left===!0?e.push(f.getTileData("excluding-tiles","top","rightValue")):m.bottom===!0&&m.right===!0?e.push(f.getTileData("excluding-tiles","top","leftValue")):m.bottom===!0&&m.top===!0?e.push(f.getTileData("open-tiles","parallel","topBottomValue")):m.left===!0&&m.right===!0?e.push(f.getTileData("open-tiles","parallel","leftRightValue")):m.top===!0?e.push(f.getTileData("open-tiles","open","topValue")):m.right===!0?e.push(f.getTileData("open-tiles","open","rightValue")):m.left===!0?e.push(f.getTileData("open-tiles","open","leftValue")):m.bottom===!0&&e.push(f.getTileData("open-tiles","open","bottomValue")),this.allSquareSidesSimilar(m)===!0&&4!==n.count&&(n.topLeft===!1&&e.push(f.getTileData("enclosing-tiles","bottom","rightValue")),n.topRight===!1&&e.push(f.getTileData("enclosing-tiles","bottom","leftValue")),n.bottomLeft===!1&&e.push(f.getTileData("enclosing-tiles","top","rightValue")),n.bottomRight===!1&&e.push(f.getTileData("enclosing-tiles","top","leftValue"))),Commons.log("Final Tiles",e,Commons.validLogKeys.tmxRenderLogKey),e}},ScaledMap=function(){var a=[],b=[],c=[],d=[],e=[],f=33,g=33,h=-1,k=!1,l=["","","",""],m=[],n=!1,o=["terrain","decoration"],p=function(c){var d=0,e=f*g,h=Commons.getTerrainByKey(a,c);for(var i in b)for(var j in b)b[i][j]<=h.getData().terrainUpperValue&&b[i][j]>=h.getData().terrainLowerValue&&d++;var k=d/e*100;return Commons.log(h.getData().terrainKey+" Percentage of Terrain",k,Commons.validLogKeys.mapValidationLogKey),k},q=function(){if(n===!1){for(k===!1&&a[0].SetDefault(),i=0;i<f;i++){var c=[];for(j=0;j<g;j++)c.push(h);b.push(c)}Commons.log("Map Values Empty",b,Commons.validLogKeys.mapInitializeLogKey),n=!0}},r=function(){l=["","","",""],m=[];var c=[],d=0,e=Commons.getMainTerrains(a);Commons.log("Regular Terrains",e,Commons.validLogKeys.mapInitializeLogKey);for(var h in e)if(e[h].terrainStartCount>0){var k={};k.terrainKey=e[h].terrainKey,k.count=e[h].terrainStartCount,k.nextPercent=e[h].terrainStartPercent,d+=e[h].terrainStartCount,c.push(k)}c.sort(function(a,b){return b.count-a.count});var n=4,o=[];if(4>=d){n=4-d;for(var p in c)for(j=0;j<c[p].count;j++){var q=Commons.randomizeWithException(0,3,o);o.push(q),l[q]=c[p].terrainKey}}if(Commons.log("Empty Non Optional Slots to Use",n,Commons.validLogKeys.mapInitializeLogKey),0!==n){var r=0,s=0,t=[],u=[];for(var v in e){var w={};e[v].terrainStartPercent>0?(s+=e[v].terrainStartPercent,w.terrainKey=e[v].terrainKey,w.cumulativePercent=s,t.push(w)):(w.terrainKey=e[v].terrainKey,u.push(w))}if(s>100){Commons.warn("Optional percentages are not over 100, Normalizing Values to 0 to 100 Range");for(r in t)t[r].cumulativePercent=t[r].cumulativePercent/s*100}for(i=0;i<n;i++){var x=Commons.randomizeWithException(0,3,o);o.push(x);var y=Commons.randomize(0,s),z=null,A=!1;for(r in t)if(y<=t[r].cumulativePercent){A=!0,z=t[r].terrainKey;break}A===!1&&(z=Commons.randomizeInArray(u).terrainKey),l[x]=z}}Commons.log("Start Terrain Keys",l,Commons.validLogKeys.mapInitializeLogKey);for(var B in l){var C=Commons.getTerrainByKey(a,l[B]);m.push(C.getRandomTerrainValue())}Commons.log("Start Terrain Values",m,Commons.validLogKeys.mapInitializeLogKey),b[0][0]=m[0],b[0][g-1]=m[1],b[f-1][0]=m[2],b[f-1][g-1]=m[3],Commons.log("Map Values After Starting Values",b,Commons.validLogKeys.mapInitializeLogKey)},s=function(){var c=Commons.getTerrainMaximum(a).getData().terrainUpperValue,d=Commons.getTerrainMinimum(a).getData().terrainLowerValue;for(var f in b)for(var g in b)b[f][g]<d&&(b[f][g]=d),b[f][g]>c&&(b[f][g]=c);e=[]},t=function(){0!==e.length},u=function(a,b){Commons.info("Diamond Step Starting"),v(a/2,a/2,a,b),Commons.info("Square Step Starting"),w(a/2,a/2,a,b)},v=function(a,c,d,e){var f=Math.floor(d/2),g=Math.floor(f/2);Commons.log("HalfBoxSize",f,Commons.validLogKeys.diamondSquareLogKey),Commons.log("QuarterBoxSize",g,Commons.validLogKeys.diamondSquareLogKey),Commons.log("Getting Average of",["["+(a-f)+"],["+(c-f)+"]","["+(a-f)+"],["+(c+f)+"]","["+(a+f)+"],["+(c-f)+"]","["+(a+f)+"],["+(c+f)+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a][c]=Commons.getAverage([b[a-f][c-f],b[a-f][c+f],b[a+f][c-f],b[a+f][c+f]]),Commons.log("Value of Center ["+a+"]["+c+"]",b[a][c],Commons.validLogKeys.diamondSquareLogKey),f>=2&&(v(a-g,c-g,f,e),v(a+g,c-g,f,e),v(a-g,c+g,f,e),v(a+g,c+g,f,e))},w=function(a,c,d,e){var f=Math.floor(d/2),g=Math.floor(f/2);Commons.log("HalfBoxSize",f,Commons.validLogKeys.diamondSquareLogKey),Commons.log("QuarterBoxSize",g,Commons.validLogKeys.diamondSquareLogKey),Commons.log("Getting Average of",["["+(a-f)+"],["+(c-f)+"]","["+a+"],["+c+"]","["+(a-f)+"],["+(c+f)+"]","["+(a-d)+"],["+c+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a-f][c]=Commons.getAverage([Commons.tryGetArrayValue(b,a-f,c-f),Commons.tryGetArrayValue(b,a,c),Commons.tryGetArrayValue(b,a-f,c+f),Commons.tryGetArrayValue(b,a-d,c)])+Commons.randomizePlusMinus(0,5),Commons.log("Value of ["+(a-f)+"]["+c+"]",b[a-f][c],Commons.validLogKeys.diamondSquareLogKey),Commons.log("Getting Average of",["["+(a+f)+"],["+(c-f)+"]","["+a+"],["+c+"]","["+(a+f)+"],["+(c+f)+"]","["+(a+d)+"],["+c+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a+f][c]=Commons.getAverage([Commons.tryGetArrayValue(b,a+f,c-f),Commons.tryGetArrayValue(b,a,c),Commons.tryGetArrayValue(b,a+f,c+f),Commons.tryGetArrayValue(b,a+d,c)])+Commons.randomizePlusMinus(0,5),Commons.log("Value of ["+(a+f)+"]["+c+"]",b[a+f][c]),Commons.log("Getting Average of",["["+(a-f)+"],["+(c-f)+"]","["+a+"],["+c+"]","["+(a+f)+"],["+(c-f)+"]","["+a+"],["+(c-d)+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a][c-f]=Commons.getAverage([Commons.tryGetArrayValue(b,a-f,c-f),Commons.tryGetArrayValue(b,a,c),Commons.tryGetArrayValue(b,a+f,c-f),Commons.tryGetArrayValue(b,a,c-d)])+Commons.randomizePlusMinus(0,5),Commons.log("Value of ["+a+"]["+(c-f)+"]",b[a][c-f],Commons.validLogKeys.diamondSquareLogKey),Commons.log("Getting Average of",["["+(a-f)+"],["+(c+f)+"]","["+a+"],["+c+"]","["+(a+f)+"],["+(c+f)+"]","["+a+"],["+(c+d)+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a][c+f]=Commons.getAverage([Commons.tryGetArrayValue(b,a-f,c+f),Commons.tryGetArrayValue(b,a,c),Commons.tryGetArrayValue(b,a+f,c+f),Commons.tryGetArrayValue(b,a,c+d)])+Commons.randomizePlusMinus(0,5),Commons.log("Value of ["+a+"]["+(c+f)+"]",b[a][c+f],Commons.validLogKeys.diamondSquareLogKey),f>=2&&(w(a-g,c-g,f,e),w(a+g,c-g,f,e),w(a-g,c+g,f,e),w(a+g,c+g,f,e))},x=function(b){var c=[];for(var d in a)a[d].getData().terrainUpperValue>=b&&a[d].getData().terrainLowerValue<=b&&c.push(a[d]);return c},y=function(){for(var a in b){var d=[];for(var e in b[a]){var f=x(b[a][e]);for(var g in f)if(f[g].isRegularTerrain()===!0){terrainKey=f[g].getData().terrainKey;break}d.push(terrainKey)}c.push(d)}return c},z=function(){var a,c;for(var e in b){var f=[];for(var g in b[e]){var h=x(b[e][g]),i=[],j=[],k=[];for(var l in h)h[l].isDecorationTerrain()===!0&&h[l].getDecorationData().overlap===!1?i.push(h[l]):h[l].isDecorationTerrain()===!0&&h[l].getDecorationData().overlap===!0&&j.push(h[l]);var m=0,n=100*i.length;for(a in i)m+=i[a].getDecorationData().placementPercent;if(m>n){Commons.warn("Error Adding Placement Percentage of Decoration Terrains - Reverting Terrains to 100% per terrain"),m=100*i.length;for(a in i)i[a].getDecorationData().placementPercent=100}var o=Commons.randomize(0,n),p=null;for(a in i)if(o<=i[a].getDecorationData().placementPercent){p=i[a];break}p&&k.push(p);for(c in j)o=Commons.randomize(0,100),o<=j[c].getDecorationData().placementPercent&&k.push(j[c]);f.push(k)}d.push(f)}return d};this.setDimensions=function(a,b){f=a,g=b},this.addTerrain=function(b){var c=new ScaledTerrain;"zLevel"in b?c.createTerrain(b.label,b.key,b.max,b.min,b.zLevel):c.createTerrain(b.label,b.key,b.max,b.min,0),"type"in b&&(-1!==o.indexOf(b.type)?c.setType(b.type):Commons.error("Error Adding Terrain Type : "+b.type)),"default"in b&&k===!1&&(k=!0,c.setDefault()),Commons.log("Adding Terrain",c.getData(),Commons.validLogKeys.mapInitializeLogKey),a.push(c)},this.addStartingCondition=function(b){var c=Commons.getTerrainByKey(a,b.terrainKey);c.setStartingCondition(b.minCount,b.optionalPercent)},this.addValidationRule=function(b){var c=b.terrainKey,d=-1,e=-1;"minPercent"in b&&(d=b.minPercent),"maxPercent"in b&&(e=b.maxPercent),Commons.getTerrainByKey(a,c).setValidation(d,e)},this.setTileInfo=function(b){var c=b.terrainKey,d=b.tiles,e=b.decoration?b.decoration:!1;Commons.getTerrainByKey(a,c).setTileInfo(d),Commons.getTerrainByKey(a,c).setDecorationData(e)},this.checkRegularTerrainValidity=function(){var b=Commons.getMainTerrains(a),c=!0;for(var d in b){var f=p(b[d].terrainKey),g=null;-1!=b[d].terrainValidationMinPercent&&f<b[d].terrainValidationMinPercent&&(c=!1,g=new ScaledValidityReport(b[d].terrainKey,Math.abs(f-b[d].terrainValidationMinPercent),!0)),-1!=b[d].terrainValidationMaxPercent&&f>b[d].terrainValidationMaxPercent&&(c=!1,g=new ScaledValidityReport(b[d].terrainKey,Math.abs(f-b[d].terrainValidationMaxPercent),!1)),null!==g&&e.push(g)}return Commons.log("Validity Reports",e,Commons.validLogKeys.mapValidationLogKey),c},this.generateMapValues=function(){Commons.info("Map Init Starting"),Commons.log("Terrains Before Map Generation",a,Commons.validLogKeys.mapInitializeLogKey),q(),r(),Commons.info("Pre Generation Clean Up"),t(),Commons.info("Diamond Square Algorithm Starting"),u(f-1,null),Commons.info("Post Generation Clean Up"),s()},this.getLayersFromValue=function(a){return x(a)},this.getTmxSettings=function(){y(),z();var b={mapValues:c,terrains:a,mapValuesDecoration:d};return b},this.getMapValues=function(){return b}},ScaledTerrain=function(){this.terrainKey=-1;var a=-1,b=-1,c=-1,d=-1,e="terrain",f=!1,g=0,h=0,i=-1,j=-1,k=-1,l=!1;this.createTerrain=function(e,f,g,h,i){this.terrainKey=f,a=g,b=h,c=e,d=i},this.setStartingCondition=function(a,b){h=b,g=a},this.setDefault=function(){f=!0},this.setType=function(a){e=a},this.getRandomTerrainValue=function(){return Commons.randomize(b,a)},this.isRegularTerrain=function(){return"terrain"==e?!0:!1},this.isDecorationTerrain=function(){return"decoration"==e?!0:!1},this.setValidation=function(a,b){i=a,j=b},this.setDecorationData=function(a){l=a},this.getDecorationData=function(){return l},this.setTileInfo=function(a){k=a},this.getTiles=function(){return k},this.getTileData=function(a,b,d){var e=this.getTiles(),f=!1;for(var g in e)if(e[g].type==a&&e[g].placement==b){f=e[g];break}return f&&f[d]?f[d]:(Commons.error("Can't Find Tile Information for Layer: "+c+", Tile Data: "+a+", "+b+", "+d),!1)},this.getData=function(){var l={terrainKey:this.terrainKey,terrainUpperValue:a,terrainLowerValue:b,terrainLabel:c,terrainZLevel:d,terrainType:e,terrainDefault:f,terrainStartCount:g,terrainStartPercent:h,terrainValidationMinPercent:i,terrainValidationMaxPercent:j,terrainTileInfo:k};return l}},ScaledTmxGen=function(a){var b=1,c="",d=[],e=[],f=[],g=[],h=null,i=null,j=null,k=null;a&&(e=a.mapValues?a.mapValues:[],d=a.terrains?a.terrains:[],h=a.tilesetSettings?a.tilesetSettings:null,k=a.domSettings?a.domSettings:null,f=a.mapValuesDecoration?a.mapValuesDecoration:[]),j={terrains:d,domination:k},i=new ScaledEdgeDetector(j);var l=function(a,b){var c=[];return a=parseInt(a),b=parseInt(b),c.push(Commons.tryGetArrayValue(e,a-1,b)),c.push(Commons.tryGetArrayValue(e,a,b+1)),c.push(Commons.tryGetArrayValue(e,a+1,b)),c.push(Commons.tryGetArrayValue(e,a,b-1)),c},m=function(a,b){var c=[];return a=parseInt(a),b=parseInt(b),c.push(Commons.tryGetArrayValue(e,a-1,b-1)),c.push(Commons.tryGetArrayValue(e,a-1,b+1)),c.push(Commons.tryGetArrayValue(e,a+1,b+1)),c.push(Commons.tryGetArrayValue(e,a+1,b-1)),c},n=function(){var a=[];for(var c in e){var d=[];for(var f in e[c])d.push(b);a.push(d)}g.push(a)},o=function(){var a=Commons.getDefaultTerrain(d).getTileData("other-tiles","all","fullValue"),b=[];for(var c in e){var f=[];for(var h in e[c])f.push(a);b.push(f)}g.push(b)},p=function(a,b,c){for(var d in g)if(g[d][b][c]==a)return!0;return!1},q=function(a,c){for(var d in g)if(g[d][a][c]===b)return d;return-1},r=function(a,b,c){1===g.length&&n(),b=parseInt(b),c=parseInt(c);for(var d in a){var e=a[d];if(p(e,b,c)===!1){var f=q(b,c);if(-1!==f)g[f][b][c]=e;else{var h=g.length;n(),g[h][b][c]=e}}}},s=function(a){c+='<layer name="layer_'+a+'" width="'+g[0].length+'" height="'+g[0].length+'">',c+="<data>"},t=function(){c+="</data>",c+="</layer>"},u=function(a){c+='<tile gid="'+a+'" />'},v=function(a){var b,c,d=a.getData().terrainTileInfo,e=0,f=null;for(b in d)d[b].weight&&(e+=d[b].weight);c=Commons.randomize(0,e);for(b in d)if(c<=d[b].weight){f=d[b];break}return f&&!f.dimensions?f.value:-1},w=function(a,b){var c=e[a][b],d=i.getAdjacentSimilarity(c,l(a,b));return i.allSquareSidesSimilar(d)===!0?!0:!1},x=function(){for(var a in e)for(var b in e[a])if(f[a]){var c=f[a][b],d=[];if(c&&0!==c.length&&w(a,b)){for(var g in c)d.push(v(c[g]));Commons.removeKeyFromArray(d,-1)}d&&d.length>0&&r(d,a,b)}};this.generateMapTmx=function(){Commons.info("TMX - Generating Layered Map"),this.generateLayeredMap(),Commons.info("TMX - Decorating Map"),x(),Commons.info("TMX - Generating Map XML"),this.generateMapXml()},this.getTmxXml=function(){return c},this.generateLayeredMap=function(){o();for(var a in e)for(var b in e[a]){Commons.log("Primary Pos",a+","+b,Commons.validLogKeys.tmxRenderLogKey);var c=l(a,b),d=m(a,b),f=i.resolveTileValue(e[a][b],c,d);r(f,a,b)}},this.generateMapXml=function(){c+='<?xml version="1.0" encoding="UTF-8"?>',c+='<map version="1.0" orientation="orthogonal" renderorder="left-up" width="'+g[0].length+'" height="'+g[0].length+'" tilewidth="'+h.tileWidth+'" tileheight="'+h.tileHeight+'" nextobjectid="1">',c+='<tileset firstgid="1" name="tileset" tilewidth="'+h.tileWidth+'" tileheight="'+h.tileHeight+'">',c+='<image source="'+h.source+'" trans="ffffff" width="'+h.width+'" height="'+h.height+'"/>',c+="</tileset>";for(var a in g){s(a);for(var b in g[a])for(var d in g[a][b])u(g[a][b][d]);t()}c+="</map>"}},ScaledValidityReport=function(a,b,c){this.terrainKey=a,this.repairMagnitude=b,this.positiveIncrease=c},ScaledAutoReview=function(a,b){this.terrain=a,this.validityReport=b};