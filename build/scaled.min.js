!function(a,b){"function"==typeof define&&define.amd?define(["scaled-gen"],b):"object"==typeof module&&module.exports?module.exports=b():a.ScaledGen=b()}(this,function(){var a=function(a){var b=10,c=new Scaled.ScaledMap,d=null,e=null,f=null;a&&(Scaled.Commons.debug=a.debug?!0:!1,Scaled.Commons.allowedLogs=a.logs?a.logs:[],Scaled.Commons.showProgressUpdate=a.onProgressUpdate?a.onProgressUpdate:function(){},b=a.maxTries?a.maxTries:10),this.getMapValues=function(){return c.getMapValues()},this.setMapSize=function(a,b){c.setDimensions(a,b)},this.addTerrain=function(a){c.addTerrain(a)},this.addStartingCondition=function(a){c.addStartingCondition(a)},this.addValidationRule=function(a){c.addValidationRule(a)},this.addLayerDomination=function(a){e=a},this.addTileset=function(a){f=a},this.setTileInfo=function(a){c.setTileInfo(a)},this.generateMapValues=function(){var a=!1,d=0;do c.generateMapValues(),a=c.checkRegularTerrainValidity(),d++;while(a===!1&&b>d);a===!1&&Scaled.Commons.error("Unable to Validate Map. Perhaps Conditions set are too Strict.")},this.generateMap=function(){if(this.generateMapValues(),e&&f){var a=c.getTmxSettings();a.domSettings=e,a.tilesetSettings=f,d=new Scaled.ScaledTmxGen(a),d.generateMapTmx()}else Scaled.Commons.warn("No Domination Settings / TileSet Settings provided skipping TMX Generation")},this.getTmxXml=function(){return d.getTmxXml()},this.getLayeredMap=function(){return d.getLayeredMap()},this.renderMapValues=function(a){var b=document.getElementById(a);b.innerHTML="";var d=c.getMapValues(),e="";for(var f in d)e+=g(d[f]);b.innerHTML=e},this.getRegularTerrainPercentages=function(){return c.getRegularTerrainPercentages()};var g=function(a){var b="<div class='row'>";for(var c in a)b+=h(a[c]);return b+="</div>"},h=function(a){var b=c.getLayersFromValue(a);Scaled.Commons.log("Terrains For Cell Value : "+a,b,Scaled.Commons.validLogKeys.mapRenderLogKey);var d="no-cell";for(var e in b)if(b[e].isRegularTerrain()===!0){d=b[e].getData().terrainKey;break}var f="";return f+="<div class='cell "+d+" ",f+="data-value='"+a+"' ",f+="'>",f+="</div>"}};return a});var Scaled=function(a){var b={debug:!1,allowedLogs:["all"],validLogKeys:{mapInitializeLogKey:"mapInit",diamondSquareLogKey:"diamondSquare",mapValidationLogKey:"mapValidation",mapRenderLogKey:"mapRender",tmxRenderLogKey:"tmxRender",decorationRenderLogKey:"decorationRender",correctionLogKey:"correction"},showProgressUpdate:function(){}},c=4;return b.consoleLog=function(a,b){this.debug===!0},b.log=function(a,b,c){this.debug!==!0||-1==this.allowedLogs.indexOf(c)&&"all"!=this.allowedLogs[0]||this.consoleLog("["+c+"] "+a,b)},b.warn=function(a){this.debug===!0},b.info=function(a){this.debug===!0},b.error=function(a){this.debug===!0},b.roundNumber=function(a){return Math.round(a)},b.randomize=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},b.randomizeInArray=function(a){var b=0,c=a.length-1,d=this.randomize(b,c);return a[d]},b.randomizeWithException=function(a,b,c){var d=-1;do d=this.randomize(a,b);while(-1!=c.indexOf(d));return d},b.randomizePlusMinus=function(a,b){{var d=this.randomize(1,10);this.randomize(a,b)}return c>=d?-1*d:d},b.randomizePlusMinusControlled=function(a,b,c,d,e){{var f=this.randomize(c,d);this.randomize(a,b)}return e>=f?-1*f:f},b.getAverage=function(a){this.log("Array Came",a);var b=0,c=0;for(var d in a)-1!=a[d]&&(b+=a[d],c++);var e=b/c;return this.log("Avg",e),e},b.tryGetArrayValue=function(a,b,c){return b in a&&c in a[b]?a[b][c]:-1},b.isPointAtEdge=function(a,b,c){return b=parseInt(b),c=parseInt(c),0===b||0===c?!0:b==a.length||c==a[0].length?!0:!1},b.getDefaultTerrain=function(a){for(var b in a)if(a[b].getData().terrainDefault===!0)return a[b]},b.getMainTerrains=function(a){var b=[];for(var c in a)a[c].isRegularTerrain()===!0&&b.push(a[c].getData());return b},b.removeKeyFromArray=function(a,b){for(var c in a)a[c]===b&&a.splice(c,1)},b.getDecorationTerrains=function(a){var b=[];for(var c in a)a[c].isDecorationTerrain()===!0&&b.push(a[c].getData());return b},b.getTerrainByKey=function(a,b){for(var c in a)if(a[c].terrainKey==b)return a[c];return!1},b.getTerrainMaximum=function(a){var b=-1,c=null;for(var d in a)a[d].isRegularTerrain()===!0&&a[d].getData().terrainUpperValue>b&&(b=a[d].getData().terrainUpperValue,c=a[d]);return c},b.getTerrainMinimum=function(a){var b=101,c=null;for(var d in a)a[d].isRegularTerrain()===!0&&a[d].getData().terrainLowerValue<b&&(b=a[d].getData().terrainLowerValue,c=a[d]);return c},a.Commons=b,a}(Scaled||{}),Scaled=function(a){var b=function(b){var c=b.terrains,d=b.domination,e=d.dominationPriority,f=function(a){return e.indexOf(a)},g=function(a){return e[a]},h=function(a,b){return a-b},i=function(a){for(var b={},c=[],d=0,e=a.length;e>d;++d)b.hasOwnProperty(a[d])||(c.push(a[d]),b[a[d]]=1);return c},j=function(a,b){var c=[];for(var d in b)c.push(-1!==b[d]&&f(b[d])<f(a)?b[d]:a);return c},k=function(b,c){var d,e=[],j=f(b);for(var k in c)if(-1!==c[k]){var l=f(c[k]);e.push(l)}a.Commons.log("Primary Value",b,a.Commons.validLogKeys.tmxRenderLogKey),a.Commons.log("Surroundings",c,a.Commons.validLogKeys.tmxRenderLogKey),a.Commons.log("Before Unique",e,a.Commons.validLogKeys.tmxRenderLogKey),e=i(e),a.Commons.log("After Unique",e,a.Commons.validLogKeys.tmxRenderLogKey),e.sort(h);var m=Math.min.apply(null,e);if(m==j)d=j;else{var n=e.indexOf(j);d=0!==n&&-1!=n?e[n-1]:e[0]}return a.Commons.log("Returning",g(d),a.Commons.validLogKeys.tmxRenderLogKey),g(d)};this.allSquareSidesSimilar=function(a){return a.top===!0&&a.left===!0&&a.right===!0&&a.bottom===!0?!0:!1},this.getDiagonalSimilarity=function(a,b){var c={topLeft:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,count:0};return b[0]==a&&(c.topLeft=!0,c.count++),b[1]==a&&(c.topRight=!0,c.count++),b[2]==a&&(c.bottomRight=!0,c.count++),b[3]==a&&(c.bottomLeft=!0,c.count++),c},this.getAdjacentSimilarity=function(a,b){var c={top:!1,left:!1,right:!1,bottom:!1,count:0};return b[0]==a&&(c.top=!0,c.count++),b[1]==a&&(c.right=!0,c.count++),b[2]==a&&(c.bottom=!0,c.count++),b[3]==a&&(c.left=!0,c.count++),c},this.resolveTileValue=function(b,d,e){if(a.Commons.getDefaultTerrain(c).terrainKey==b)return[];a.Commons.log("Primary Cell Layer",b,a.Commons.validLogKeys.tmxRenderLogKey),a.Commons.log("Adjacent Values",d,a.Commons.validLogKeys.tmxRenderLogKey),a.Commons.log("Diagonal Values",e,a.Commons.validLogKeys.tmxRenderLogKey);var f=[],g=a.Commons.getTerrainByKey(c,b),h=k(b,d);a.Commons.log("Lowest Domination",h,a.Commons.validLogKeys.tmxRenderLogKey);var i=a.Commons.getTerrainByKey(c,h).getTileData("other-tiles","all","fullValue");f.push(i);var l=j(b,d),m=j(b,e),n=this.getAdjacentSimilarity(b,l),o=this.getDiagonalSimilarity(b,m);return a.Commons.log("Similarity",n,a.Commons.validLogKeys.tmxRenderLogKey),this.allSquareSidesSimilar(n)===!0?f.push(g.getTileData("other-tiles","all","fullValue")):0===n.count?f.push(g.getTileData("open-tiles","open","noneValue")):n.top===!0&&n.left===!0&&n.right===!0?f.push(g.getTileData("enclosing-tiles","top","topValue")):n.bottom===!0&&n.left===!0&&n.right===!0?f.push(g.getTileData("enclosing-tiles","bottom","bottomValue")):n.top===!0&&n.bottom===!0&&n.right===!0?f.push(g.getTileData("enclosing-tiles","right","rightValue")):n.top===!0&&n.bottom===!0&&n.left===!0?f.push(g.getTileData("enclosing-tiles","left","leftValue")):n.top===!0&&n.left===!0?f.push(g.getTileData("excluding-tiles","bottom","rightValue")):n.top===!0&&n.right===!0?f.push(g.getTileData("excluding-tiles","bottom","leftValue")):n.bottom===!0&&n.left===!0?f.push(g.getTileData("excluding-tiles","top","rightValue")):n.bottom===!0&&n.right===!0?f.push(g.getTileData("excluding-tiles","top","leftValue")):n.bottom===!0&&n.top===!0?f.push(g.getTileData("open-tiles","parallel","topBottomValue")):n.left===!0&&n.right===!0?f.push(g.getTileData("open-tiles","parallel","leftRightValue")):n.top===!0?f.push(g.getTileData("open-tiles","open","topValue")):n.right===!0?f.push(g.getTileData("open-tiles","open","rightValue")):n.left===!0?f.push(g.getTileData("open-tiles","open","leftValue")):n.bottom===!0&&f.push(g.getTileData("open-tiles","open","bottomValue")),this.allSquareSidesSimilar(n)===!0&&4!==o.count&&(o.topLeft===!1&&f.push(g.getTileData("enclosing-tiles","bottom","rightValue")),o.topRight===!1&&f.push(g.getTileData("enclosing-tiles","bottom","leftValue")),o.bottomLeft===!1&&f.push(g.getTileData("enclosing-tiles","top","rightValue")),o.bottomRight===!1&&f.push(g.getTileData("enclosing-tiles","top","leftValue"))),a.Commons.log("Final Tiles",f,a.Commons.validLogKeys.tmxRenderLogKey),f}};return a.ScaledEdgeDetector=b,a}(Scaled||{}),Scaled=function(a){var b=function(a){this.terrainKey=a;var b=0,c=0,d=0;this.increment=function(){b++,d++,c=b/d*100},this.silentIncrement=function(){b++,c=b/d*100},this.silentDecrement=function(){b--,c=b/d*100},this.pass=function(){d++,c=b/d*100},this.getPercent=function(){return c}};return a.ScaledGenProgress=b,a}(Scaled||{}),Scaled=function(a){var b=function(){var b=[],c=[],d=[],e=[],f=[],g=[],h=[],k=[],l=[],m=33,n=33,o=-1,p=!1,q=["","","",""],r=[],s=!1,t=["terrain","decoration"],u=function(c){var e=0,f=m*n,g=a.Commons.getTerrainByKey(b,c);for(var h in d)for(var i in d)d[h][i]<=g.getData().terrainUpperValue&&d[h][i]>=g.getData().terrainLowerValue&&e++;var j=e/f*100;return a.Commons.log(g.getData().terrainKey+" Percentage of Terrain",j,a.Commons.validLogKeys.mapValidationLogKey),j},v=function(){if(s===!1){for(p===!1&&b[0].SetDefault(),i=0;i<m;i++){var c=[];for(j=0;j<n;j++)c.push(o);d.push(c)}a.Commons.log("Map Values Empty",d,a.Commons.validLogKeys.mapInitializeLogKey),s=!0}},w=function(a,b){return b.repairMagnitude-a.repairMagnitude},x=function(){q=["","","",""],r=[];var c,e=[],f=0,g=a.Commons.getMainTerrains(b);a.Commons.log("Regular Terrains",g,a.Commons.validLogKeys.mapInitializeLogKey);for(var h in g)if(g[h].terrainStartCount>0){var k={};k.terrainKey=g[h].terrainKey,k.count=g[h].terrainStartCount,k.nextPercent=g[h].terrainStartPercent,f+=g[h].terrainStartCount,e.push(k)}e.sort(function(a,b){return b.count-a.count});var l=4,o=[];if(4>=f){l=4-f;for(var p in e)for(j=0;j<e[p].count;j++){var s=a.Commons.randomizeWithException(0,3,o);o.push(s),q[s]=e[p].terrainKey}}if(a.Commons.log("Empty Non Optional Slots to Use",l,a.Commons.validLogKeys.mapInitializeLogKey),0!==l){var t=0,u=0,v=[],w=[];for(c in g){var x={};g[c].terrainStartPercent>0?(u+=g[c].terrainStartPercent,x.terrainKey=g[c].terrainKey,x.cumulativePercent=u,v.push(x)):(x.terrainKey=g[c].terrainKey,w.push(x))}if(u>100){a.Commons.warn("Optional percentages are not over 100, Normalizing Values to 0 to 100 Range");for(t in v)v[t].cumulativePercent=v[t].cumulativePercent/u*100}for(i=0;i<l;i++){var y=a.Commons.randomizeWithException(0,3,o);o.push(y);var z=a.Commons.randomize(0,u),A=null,B=!1;for(t in v)if(z<=v[t].cumulativePercent){B=!0,A=v[t].terrainKey;break}B===!1&&(A=a.Commons.randomizeInArray(w).terrainKey),q[y]=A}}a.Commons.log("Start Terrain Keys",q,a.Commons.validLogKeys.mapInitializeLogKey);for(var C in q){var D=a.Commons.getTerrainByKey(b,q[C]);r.push(D.getRandomTerrainValue())}a.Commons.log("Start Terrain Values",r,a.Commons.validLogKeys.mapInitializeLogKey),d[0][0]=r[0],d[0][n-1]=r[1],d[m-1][0]=r[2],d[m-1][n-1]=r[3],a.Commons.log("Map Values After Starting Values",d,a.Commons.validLogKeys.mapInitializeLogKey)},y=function(){var c=a.Commons.getTerrainMaximum(b).getData().terrainUpperValue,e=a.Commons.getTerrainMinimum(b).getData().terrainLowerValue;for(var f in d)for(var h in d)d[f][h]<e&&(d[f][h]=e),d[f][h]>c&&(d[f][h]=c);g=[]},z=function(){if(0!==g.length){for(var d in g)g[d].positiveIncrease?h.push(g[d]):k.push(g[d]);h.sort(w)}var e,f=0,i=0,j=0,m=0,n=0;c=a.Commons.getMainTerrains(b),l=[];for(e in c)l.push(new a.ScaledGenProgress(c[e].terrainKey)),c[e].terrainValidationMinPercent>=0&&(f+=c[e].terrainValidationMinPercent,j++),c[e].terrainValidationMaxPercent>=0&&(i+=c[e].terrainValidationMaxPercent,m++);if(f>100){n=100*j;for(e in b)if(b[e].isRegularTerrain()&&b[e].getData().terrainValidationMinPercent>=0){a.Commons.warn("Before"+b[e].terrainKey+" "+b[e].getData().terrainValidationMinPercent);var o=b[e].getData().terrainValidationMinPercent/n*100,p=b[e].getData().terrainValidationMaxPercent;b[e].setValidation(o,p)}}if(i>100){a.Commons.warn("Max Percent Validation Rules are Above 100% - Normalizing Values to range [0,100]"),n=100*m;for(e in b)if(b[e].isRegularTerrain()&&b[e].getData().terrainValidationMaxPercent>=0){var q=b[e].getData().terrainValidationMaxPercent/n*100,r=b[e].getData().terrainValidationMinPercent;b[e].setValidation(r,q)}}},A=function(a,b){var c=(a.terrainLowerValue+a.terrainUpperValue)/2,d=(b.terrainLowerValue+b.terrainUpperValue)/2;return Math.abs(c-d)},B=function(b,d,e){var f=!1,g=!1;if((-1!==d.terrainValidationMinPercent&&d.terrainValidationMinPercent<=e.getPercent()||-1===d.terrainValidationMinPercent)&&(f=!0),(-1!==d.terrainValidationMaxPercent&&d.terrainValidationMaxPercent>=e.getPercent()||-1===d.terrainValidationMaxPercent)&&(g=!0),g&&f){a.Commons.log("Can Replace Values for "+d.terrainKey+" Current Percent: "+e.getPercent()+" Validation Percentages: ("+d.terrainValidationMinPercent+","+d.terrainValidationMaxPercent+")",d.terrainValidationMinPercent,a.Commons.validLogKeys.correctionLogKey);var h=!1,i=!1,j=!1,k=!1,m=Number.MAX_VALUE;for(var n in l){var o=!1,p=!1;if(l[n].terrainKey!==d.terrainKey){for(var q in c)if(c[q].terrainKey==l[n].terrainKey){h=c[q];break}if(h&&((-1!==h.terrainValidationMinPercent&&h.terrainValidationMinPercent<=l[n].getPercent()||-1===h.terrainValidationMinPercent)&&(o=!0),(-1!==h.terrainValidationMaxPercent&&h.terrainValidationMaxPercent>=l[n].getPercent()||-1===h.terrainValidationMaxPercent)&&(p=!0),!p||!o)){var r=A(d,h);a.Commons.log("Terrain Distance "+h.terrainKey+" with "+d.terrainKey,r,a.Commons.validLogKeys.correctionLogKey),m>r&&(a.Commons.log("Replacing "+d.terrainKey+" with ",h.terrainKey,a.Commons.validLogKeys.correctionLogKey),i=h,m=r,j=!0,k=l[n])}}}j&&(b=a.Commons.randomize(i.terrainLowerValue,i.terrainUpperValue),k.silentIncrement(),e.silentDecrement())}return b},C=function(c){var d,e=G(c),f=a.Commons.getMainTerrains(b);for(d in e)if(e[d].isRegularTerrain()===!0){terrainKey=e[d].getData().terrainKey;break}var g=a.Commons.getTerrainByKey(f,terrainKey);if(g){var h=!1;for(d in l)l[d].terrainKey===g.terrainKey?(l[d].increment(),h=l[d]):l[d].pass();if(h)return B(c,g,h)}return a.Commons.warn("Unable to find Regular Terrain for the Given Cell Value"),c},D=function(b,c){a.Commons.info("Diamond Step Starting"),E(b/2,b/2,b,c),a.Commons.info("Square Step Starting"),F(b/2,b/2,b,c)},E=function(b,c,e,f){var g=Math.floor(e/2),h=Math.floor(g/2);a.Commons.log("HalfBoxSize",g,a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("QuarterBoxSize",h,a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("Getting Average of",["["+(b-g)+"],["+(c-g)+"]","["+(b-g)+"],["+(c+g)+"]","["+(b+g)+"],["+(c-g)+"]","["+(b+g)+"],["+(c+g)+"]"],a.Commons.validLogKeys.diamondSquareLogKey),d[b][c]=a.Commons.getAverage([d[b-g][c-g],d[b-g][c+g],d[b+g][c-g],d[b+g][c+g]]),d[b][c]=C(d[b][c]),a.Commons.log("Value of Center ["+b+"]["+c+"]",d[b][c],a.Commons.validLogKeys.diamondSquareLogKey),g>=2&&(E(b-h,c-h,g,f),E(b+h,c-h,g,f),E(b-h,c+h,g,f),E(b+h,c+h,g,f))},F=function(b,c,e,f){var g=Math.floor(e/2),h=Math.floor(g/2);a.Commons.log("HalfBoxSize",g,a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("QuarterBoxSize",h,a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("Getting Average of",["["+(b-g)+"],["+(c-g)+"]","["+b+"],["+c+"]","["+(b-g)+"],["+(c+g)+"]","["+(b-e)+"],["+c+"]"],a.Commons.validLogKeys.diamondSquareLogKey),d[b-g][c]=a.Commons.getAverage([a.Commons.tryGetArrayValue(d,b-g,c-g),a.Commons.tryGetArrayValue(d,b,c),a.Commons.tryGetArrayValue(d,b-g,c+g),a.Commons.tryGetArrayValue(d,b-e,c)])+a.Commons.randomizePlusMinus(0,5),d[b-g][c]=C(d[b-g][c]),a.Commons.log("Value of ["+(b-g)+"]["+c+"]",d[b-g][c],a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("Getting Average of",["["+(b+g)+"],["+(c-g)+"]","["+b+"],["+c+"]","["+(b+g)+"],["+(c+g)+"]","["+(b+e)+"],["+c+"]"],a.Commons.validLogKeys.diamondSquareLogKey),d[b+g][c]=a.Commons.getAverage([a.Commons.tryGetArrayValue(d,b+g,c-g),a.Commons.tryGetArrayValue(d,b,c),a.Commons.tryGetArrayValue(d,b+g,c+g),a.Commons.tryGetArrayValue(d,b+e,c)])+a.Commons.randomizePlusMinus(0,5),d[b+g][c]=C(d[b+g][c]),a.Commons.log("Value of ["+(b+g)+"]["+c+"]",d[b+g][c]),a.Commons.log("Getting Average of",["["+(b-g)+"],["+(c-g)+"]","["+b+"],["+c+"]","["+(b+g)+"],["+(c-g)+"]","["+b+"],["+(c-e)+"]"],a.Commons.validLogKeys.diamondSquareLogKey),d[b][c-g]=a.Commons.getAverage([a.Commons.tryGetArrayValue(d,b-g,c-g),a.Commons.tryGetArrayValue(d,b,c),a.Commons.tryGetArrayValue(d,b+g,c-g),a.Commons.tryGetArrayValue(d,b,c-e)])+a.Commons.randomizePlusMinus(0,5),d[b][c-g]=C(d[b][c-g]),a.Commons.log("Value of ["+b+"]["+(c-g)+"]",d[b][c-g],a.Commons.validLogKeys.diamondSquareLogKey),a.Commons.log("Getting Average of",["["+(b-g)+"],["+(c+g)+"]","["+b+"],["+c+"]","["+(b+g)+"],["+(c+g)+"]","["+b+"],["+(c+e)+"]"],a.Commons.validLogKeys.diamondSquareLogKey),d[b][c+g]=a.Commons.getAverage([a.Commons.tryGetArrayValue(d,b-g,c+g),a.Commons.tryGetArrayValue(d,b,c),a.Commons.tryGetArrayValue(d,b+g,c+g),a.Commons.tryGetArrayValue(d,b,c+e)])+a.Commons.randomizePlusMinus(0,5),d[b][c+g]=C(d[b][c+g]),a.Commons.log("Value of ["+b+"]["+(c+g)+"]",d[b][c+g],a.Commons.validLogKeys.diamondSquareLogKey),g>=2&&(F(b-h,c-h,g,f),F(b+h,c-h,g,f),F(b-h,c+h,g,f),F(b+h,c+h,g,f))},G=function(a){var c=[];for(var d in b)b[d].getData().terrainUpperValue>=a&&b[d].getData().terrainLowerValue<=a&&c.push(b[d]);return c},H=function(){for(var a in d){var b=[];for(var c in d[a]){var f=G(d[a][c]);for(var g in f)if(f[g].isRegularTerrain()===!0){terrainKey=f[g].getData().terrainKey;break}b.push(terrainKey)}e.push(b)}return e},I=function(a,b){return a.getDecorationData().zLevel-b.getDecorationData().zLevel},J=function(){var b,c;for(var e in d){var g=[];for(var h in d[e]){var i=G(d[e][h]),j=[],k=[],l=[];for(var m in i)i[m].isDecorationTerrain()===!0&&i[m].getDecorationData().overlap===!1?j.push(i[m]):i[m].isDecorationTerrain()===!0&&i[m].getDecorationData().overlap===!0&&k.push(i[m]);a.Commons.log("Before Sort - Overlapping Decoration",k,a.Commons.validLogKeys.decorationRenderLogKey),a.Commons.log("Before Sort - Non-Overlapping Decoration",j,a.Commons.validLogKeys.decorationRenderLogKey),k.sort(I),j.sort(I),a.Commons.log("After Sort - Overlapping Decoration",k,a.Commons.validLogKeys.decorationRenderLogKey),a.Commons.log("After Sort - Non-Overlapping Decoration",j,a.Commons.validLogKeys.decorationRenderLogKey);var n=0,o=100*j.length;for(b in j)n+=j[b].getDecorationData().placementPercent;if(n>o){a.Commons.warn("Error Adding Placement Percentage of Decoration Terrains - Reverting Terrains to 100% per terrain"),n=100*j.length;for(b in j)j[b].getDecorationData().placementPercent=100}a.Commons.log("totalPercent",n,a.Commons.validLogKeys.decorationRenderLogKey);var p=a.Commons.randomize(0,o),q=null,r=0;a.Commons.log("maxValuePossible",o,a.Commons.validLogKeys.decorationRenderLogKey),a.Commons.log("randomPercent",p,a.Commons.validLogKeys.decorationRenderLogKey);for(b in j)if(r+=j[b].getDecorationData().placementPercent,r>=p){q=j[b];break}q&&(l.push(q),a.Commons.log("Pushing",q,a.Commons.validLogKeys.decorationRenderLogKey));for(c in k)p=a.Commons.randomize(0,100),p<=k[c].getDecorationData().placementPercent&&(l.push(k[c]),a.Commons.log("Pushing",k[c],a.Commons.validLogKeys.decorationRenderLogKey));g.push(l)}f.push(g)}return f};this.setDimensions=function(a,b){m=a,n=b},this.addTerrain=function(c){var d=new a.ScaledTerrain;d.createTerrain(c.label,c.key,c.max,c.min),"type"in c&&(-1!==t.indexOf(c.type)?d.setType(c.type):a.Commons.error("Error Adding Terrain Type : "+c.type)),"default"in c&&p===!1&&(p=!0,d.setDefault()),a.Commons.log("Adding Terrain",d.getData(),a.Commons.validLogKeys.mapInitializeLogKey),b.push(d)},this.addStartingCondition=function(c){var d=a.Commons.getTerrainByKey(b,c.terrainKey);d.setStartingCondition(c.minCount,c.optionalPercent)},this.addValidationRule=function(c){var d=c.terrainKey,e=-1,f=-1;if("minPercent"in c&&(e=c.minPercent),"maxPercent"in c&&(f=c.maxPercent),f=0>f?-1:f,e=0>e?-1:e,e>f&&-1!==f&&-1!==e){a.Commons.warn("Terrain ("+d+") Validation minPercent is more than its maxPercent, Swapping Values");var g=e;e=f,f=g}a.Commons.getTerrainByKey(b,d).setValidation(e,f)},this.setTileInfo=function(c){var d=c.terrainKey,e=c.tiles,f=c.decoration?c.decoration:!1;a.Commons.getTerrainByKey(b,d).setTileInfo(e),a.Commons.getTerrainByKey(b,d).setDecorationData(f)},this.checkRegularTerrainValidity=function(){var c=a.Commons.getMainTerrains(b),d=!0;for(var e in c){var f=u(c[e].terrainKey),h=null;-1!=c[e].terrainValidationMinPercent&&(f<c[e].terrainValidationMinPercent&&(d=!1),h=new a.ScaledValidityReport(c[e].terrainKey,Math.abs(f-c[e].terrainValidationMinPercent),c[e].terrainValidationMinPercent,!0)),-1!=c[e].terrainValidationMaxPercent&&(f>c[e].terrainValidationMaxPercent&&(d=!1),h=new a.ScaledValidityReport(c[e].terrainKey,Math.abs(f-c[e].terrainValidationMaxPercent),c[e].terrainValidationMaxPercent,!1)),null!==h&&g.push(h)}return a.Commons.log("Validity Reports",g,a.Commons.validLogKeys.mapValidationLogKey),d},this.getRegularTerrainPercentages=function(){var c={},d=a.Commons.getMainTerrains(b);for(var e in d){var f=u(d[e].terrainKey);c[d[e].terrainKey]=f}return c},this.generateMapValues=function(){a.Commons.info("Map Init Starting"),a.Commons.log("Terrains Before Map Generation",b,a.Commons.validLogKeys.mapInitializeLogKey),v(),x(),a.Commons.info("Pre Generation Clean Up"),z(),a.Commons.info("Diamond Square Algorithm Starting"),D(m-1,null),a.Commons.info("Post Generation Clean Up"),y()},this.getLayersFromValue=function(a){return G(a)},this.getTmxSettings=function(){H(),J();var a={mapValues:e,terrains:b,mapValuesDecoration:f};return a},this.getMapValues=function(){return d}};return a.ScaledMap=b,a}(Scaled||{}),Scaled=function(a){var b=function(){this.terrainKey=-1;var b=-1,c=-1,d=-1,e=-1,f="terrain",g=!1,h=0,i=0,j=-1,k=-1,l=-1,m=!1;this.createTerrain=function(a,e,f,g){this.terrainKey=e,b=f,c=g,d=a},this.setStartingCondition=function(a,b){i=b,h=a},this.setDefault=function(){g=!0},this.setType=function(a){f=a},this.getRandomTerrainValue=function(){return a.Commons.randomize(c,b)},this.isRegularTerrain=function(){return"terrain"==f?!0:!1},this.isDecorationTerrain=function(){return"decoration"==f?!0:!1},this.setValidation=function(a,b){j=a,k=b},this.getValidation=function(){return{minValue:j,maxValue:k}},this.setDecorationData=function(a){a.placementPercent=a.placementPercent?a.placementPercent:0,a.overlap=a.overlap?a.overlap:!1,a.zLevel=a.zLevel?a.zLevel:0,a.edgePlacement=a.edgePlacement?a.edgePlacement:!1,m=a},this.getDecorationData=function(){return m},this.setTileInfo=function(a){l=a},this.getTiles=function(){return l},this.getTileData=function(b,c,e){var f=this.getTiles(),g=!1;for(var h in f)if(f[h].type==b&&f[h].placement==c){g=f[h];break}return g&&g[e]?g[e]:(a.Commons.error("Can't Find Tile Information for Layer: "+d+", Tile Data: "+b+", "+c+", "+e),!1)},this.getData=function(){var a={terrainKey:this.terrainKey,terrainUpperValue:b,terrainLowerValue:c,terrainLabel:d,terrainZLevel:e,terrainType:f,terrainDefault:g,terrainStartCount:h,terrainStartPercent:i,terrainValidationMinPercent:j,terrainValidationMaxPercent:k,terrainTileInfo:l};return a}};return a.ScaledTerrain=b,a}(Scaled||{}),Scaled=function(a){var b=function(b){var c=1,d="",e=[],f=[],g=[],h=[],i=null,j=null,k=null,l=null;b&&(f=b.mapValues?b.mapValues:[],e=b.terrains?b.terrains:[],i=b.tilesetSettings?b.tilesetSettings:null,l=b.domSettings?b.domSettings:null,g=b.mapValuesDecoration?b.mapValuesDecoration:[]),k={terrains:e,domination:l},j=new a.ScaledEdgeDetector(k);var m=function(b,c){var d=[];return b=parseInt(b),c=parseInt(c),d.push(a.Commons.tryGetArrayValue(f,b-1,c)),d.push(a.Commons.tryGetArrayValue(f,b,c+1)),d.push(a.Commons.tryGetArrayValue(f,b+1,c)),d.push(a.Commons.tryGetArrayValue(f,b,c-1)),d},n=function(b,c){var d=[];return b=parseInt(b),c=parseInt(c),d.push(a.Commons.tryGetArrayValue(f,b-1,c-1)),d.push(a.Commons.tryGetArrayValue(f,b-1,c+1)),d.push(a.Commons.tryGetArrayValue(f,b+1,c+1)),d.push(a.Commons.tryGetArrayValue(f,b+1,c-1)),d},o=function(){var a=[];for(var b in f){var d=[];for(var e in f[b])d.push(c);a.push(d)}h.push(a)},p=function(){var b=a.Commons.getDefaultTerrain(e).getTileData("other-tiles","all","fullValue"),c=[];for(var d in f){var g=[];for(var i in f[d])g.push(b);c.push(g)}h.push(c)},q=function(a,b,c){for(var d in h)if(h[d][b][c]==a)return!0;return!1},r=function(a,b){for(var d in h)if(h[d][a][b]===c)return d;return-1},s=function(a,b,c){1===h.length&&o(),b=parseInt(b),c=parseInt(c);for(var d in a){var e=a[d];if(q(e,b,c)===!1){var f=r(b,c);if(-1!==f)h[f][b][c]=e;else{var g=h.length;o(),h[g][b][c]=e}}}},t=function(a){d+='<layer name="layer_'+a+'" width="'+h[0].length+'" height="'+h[0].length+'">',d+="<data>"},u=function(){d+="</data>",d+="</layer>"},v=function(a){d+='<tile gid="'+a+'" />'},w=function(b){var c,d,e=b.getData().terrainTileInfo,f=0,g=0,h=null;for(c in e)e[c].weight&&(f+=e[c].weight);d=a.Commons.randomize(0,f);for(c in e)if(g+=e[c].weight,g>=d){h=e[c];break}return h&&!h.dimensions?h.value:-1},x=function(a,b){var c=f[a][b],d=j.getAdjacentSimilarity(c,m(a,b));return j.allSquareSidesSimilar(d)===!0?!0:!1},y=function(){for(var b in f)for(var c in f[b])if(g[b]){var d=g[b][c],e=[],h=x(b,c);if(d&&0!==d.length){for(var i in d)(h||d[i].getDecorationData().edgePlacement)&&e.push(w(d[i]));a.Commons.removeKeyFromArray(e,-1)}e&&e.length>0&&s(e,b,c)}};this.generateMapTmx=function(){a.Commons.info("TMX - Generating Layered Map"),this.generateLayeredMap(),a.Commons.info("TMX - Decorating Map"),y(),a.Commons.info("TMX - Generating Map XML"),this.generateMapXml()},this.generateMapLayered=function(){a.Commons.info("TMX - Generating Layered Map"),this.generateLayeredMap(),a.Commons.info("TMX - Decorating Map"),y()},this.getTmxXml=function(){return d},this.getLayeredMap=function(){return h},this.generateLayeredMap=function(){p();for(var b in f)for(var c in f[b]){a.Commons.log("Primary Pos",b+","+c,a.Commons.validLogKeys.tmxRenderLogKey);var d=m(b,c),e=n(b,c),g=j.resolveTileValue(f[b][c],d,e);s(g,b,c)}},this.generateMapXml=function(){d+='<?xml version="1.0" encoding="UTF-8"?>',d+='<map version="1.0" orientation="orthogonal" renderorder="left-up" width="'+h[0].length+'" height="'+h[0].length+'" tilewidth="'+i.tileWidth+'" tileheight="'+i.tileHeight+'" nextobjectid="1">',d+='<tileset firstgid="1" name="tileset" tilewidth="'+i.tileWidth+'" tileheight="'+i.tileHeight+'">',d+='<image source="'+i.source+'" trans="ffffff" width="'+i.width+'" height="'+i.height+'"/>',d+="</tileset>";for(var a in h){t(a);for(var b in h[a])for(var c in h[a][b])v(h[a][b][c]);u()}d+="</map>"}};return a.ScaledTmxGen=b,a}(Scaled||{}),Scaled=function(a){var b=function(a,b,c,d){this.terrainKey=a,this.repairMagnitude=b,this.positiveIncrease=d,this.actualPercent=c};return a.ScaledValidityReport=b,a}(Scaled||{});