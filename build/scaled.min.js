function ScaledGen(a){var b=10,c=new ScaledMap,d=null,e=null;a&&("debug"in a&&a.debug===!0&&(Commons.debug=!0),"logs"in a&&(Commons.allowedLogs=a.logs),"maxTries"in a&&(b=a.maxTries),"onProgressUpdate"in a&&(Commons.showProgressUpdate=a.onProgressUpdate)),this.GetMapValues=function(){return c.GetMapValues()},this.SetMapSize=function(a,b){c.SetDimensions(a,b)},this.AddTerrain=function(a){c.AddTerrain(a)},this.AddStartingCondition=function(a){c.AddStartingCondition(a)},this.AddValidationRule=function(a){c.AddValidationRule(a)},this.AddLayerDomination=function(a){e=a},this.AddGidInfo=function(a){c.AddGidInfo(a)},this.GenerateMapValues=function(){var a=!1,d=0;do c.GenerateMapValues(),a=c.CheckRegularTerrainValidity(),d++;while(a===!1&&b>d);a===!1&&Commons.Error("Unable to Validate Map. Perhaps Conditions set are too Strict.")},this.GenerateMap=function(){if(this.GenerateMapValues(),e){var a=c.GetTmxSettings();a.domSettings=e,d=new ScaledTmxGen(a),d.GenerateMapTmx()}else Commons.Warn("No Domination Settings provided skipping TMX Generation")},this.GetTmxXml=function(){return d.GetTmxXml()},this.RenderMapValues=function(a){var b=document.getElementById(a);b.innerHTML="";var d=c.GetMapValues(),e="";for(var g in d)e+=f(d[g]);b.innerHTML=e};var f=function(a){var b="<div class='row'>";for(var c in a)b+=g(a[c]);return b+="</div>"},g=function(a){var b=c.GetLayersFromValue(a);Commons.Log("Terrains For Cell Value : "+a,b,Commons.validLogKeys.mapRenderLogKey);var d="no-cell";for(var e in b)if(b[e].IsRegularTerrain()===!0){d=b[e].getData().terrainKey;break}var f="";return f+="<div class='cell "+d+" ",f+="data-value='"+a+"' ",f+="'>",f+="</div>"}}var Commons={debug:!1,allowedLogs:["all"],validLogKeys:{mapInitializeLogKey:"mapInit",diamondSquareLogKey:"diamondSquare",mapValidationLogKey:"mapValidation",mapRenderLogKey:"mapRender",tmxRenderLogKey:"tmxRender"},showProgressUpdate:function(){}},PLUS_MINUS_BAR=4;Commons.ConsoleLog=function(a,b){this.debug===!0},Commons.Log=function(a,b,c){this.debug!==!0||-1==this.allowedLogs.indexOf(c)&&"all"!=this.allowedLogs[0]||this.ConsoleLog(a,b)},Commons.Warn=function(a){this.debug===!0},Commons.Error=function(a){this.debug===!0},Commons.RoundNumber=function(a){return Math.round(a)},Commons.Randomize=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},Commons.RandomizeInArray=function(a){var b=0,c=a.length-1,d=this.Randomize(b,c);return a[d]},Commons.RandomizeWithException=function(a,b,c){var d=-1;do d=this.Randomize(a,b);while(-1!=c.indexOf(d));return d},Commons.RandomizePlusMinus=function(a,b){{var c=this.Randomize(1,10);this.Randomize(a,b)}return PLUS_MINUS_BAR>=c?-1*c:c},Commons.GetAverage=function(a){this.Log("Array Came",a);var b=0,c=0;for(var d in a)-1!=a[d]&&(b+=a[d],c++);var e=b/c;return this.Log("Avg",e),e},Commons.TryGetArrayValue=function(a,b,c){return b in a&&c in a[b]?a[b][c]:-1},Commons.GetDefaultTerrain=function(a){for(var b in a)if(a[b].getData().terrainDefault===!0)return a[b]},Commons.GetMainTerrains=function(a){var b=[];for(var c in a)"terrain"==a[c].getData().terrainType&&b.push(a[c].getData());return b},Commons.GetTerrainByKey=function(a,b){for(var c in a)if(a[c].terrainKey==b)return a[c]},Commons.GetTerrainMaximum=function(a){var b=-1,c=null;for(var d in a)a[d].IsRegularTerrain()===!0&&a[d].getData().terrainUpperValue>b&&(b=a[d].getData().terrainUpperValue,c=a[d]);return c},Commons.GetTerrainMinimum=function(a){var b=101,c=null;for(var d in a)a[d].IsRegularTerrain()===!0&&a[d].getData().terrainLowerValue<b&&(b=a[d].getData().terrainLowerValue,c=a[d]);return c};var ScaledEdgeDetector=function(a){var b=a.terrains,c=a.domination,d=c.dominationPriority,e=function(a){return d.indexOf(a)},f=function(a,b){var c=a,d=e(a);for(var f in b)if(-1!==b[f]){var g=e(b[f]);d>g&&(d=g,c=b[f])}return c},g=function(a,b){var c={top:!1,left:!1,right:!1,bottom:!1,count:0};return b[0]==a&&(c.top=!0,c.count++),b[1]==a&&(c.right=!0,c.count++),b[2]==a&&(c.bottom=!0,c.count++),b[3]==a&&(c.left=!0,c.count++),c},h=function(a,b){var c={topLeft:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,count:0};return b[0]==a&&(c.topLeft=!0,c.count++),b[1]==a&&(c.topRight=!0,c.count++),b[2]==a&&(c.bottomRight=!0,c.count++),b[3]==a&&(c.bottomLeft=!0,c.count++),c},i=function(a){return a.top===!0&&a.left===!0&&a.right===!0&&a.bottom===!0?!0:!1};this.ResolveTileValue=function(a,c,d){if(Commons.GetDefaultTerrain(b).terrainKey==a)return[];Commons.Log("Primary Cell Layer",a,Commons.validLogKeys.tmxRenderLogKey),Commons.Log("Adjacent Values",c,Commons.validLogKeys.tmxRenderLogKey),Commons.Log("Diagonal Values",d,Commons.validLogKeys.tmxRenderLogKey);var e=[],j=Commons.GetTerrainByKey(b,a).getGidInfo(),k=f(a,c);if(k!=a){Commons.Log("Lowest Domination",k,Commons.validLogKeys.tmxRenderLogKey);{Commons.GetTerrainByKey(b,k).getGidInfo().other.full}}var l=g(a,c),m=h(a,d);return Commons.Log("Similarity",l,Commons.validLogKeys.tmxRenderLogKey),i(l)===!0?e.push(j.other.full):0===l.count?e.push(j.other.openLoops.openEnds.none):l.top===!0&&l.left===!0&&l.right===!0?e.push(j.enclosing.top.topValue):l.bottom===!0&&l.left===!0&&l.right===!0?e.push(j.enclosing.bottom.bottomValue):l.top===!0&&l.bottom===!0&&l.right===!0?e.push(j.enclosing.right.rightValue):l.top===!0&&l.bottom===!0&&l.left===!0?e.push(j.enclosing.left.leftValue):l.top===!0&&l.left===!0?e.push(j.excluding.bottom.rightValue):l.top===!0&&l.right===!0?e.push(j.excluding.bottom.leftValue):l.bottom===!0&&l.left===!0?e.push(j.excluding.top.rightValue):l.bottom===!0&&l.right===!0?e.push(j.excluding.top.leftValue):l.bottom===!0&&l.top===!0?e.push(j.other.openLoops.twoWay.topBottom):l.left===!0&&l.right===!0?e.push(j.other.openLoops.twoWay.leftRight):l.top===!0?e.push(j.other.openLoops.openEnds.top):l.right===!0?e.push(j.other.openLoops.openEnds.right):l.left===!0?e.push(j.other.openLoops.openEnds.left):l.bottom===!0&&e.push(j.other.openLoops.openEnds.bottom),i(l)===!0&&4!==m.count&&(m.topLeft===!1&&e.push(j.enclosing.bottom.rightValue),m.topRight===!1&&e.push(j.enclosing.bottom.leftValue),m.bottomLeft===!1&&e.push(j.enclosing.top.rightValue),m.bottomRight===!1&&e.push(j.enclosing.top.leftValue)),Commons.Log("Final Tiles",e,Commons.validLogKeys.tmxRenderLogKey),e}},ScaledMap=function(){var a=[],b=[],c=[],d=[],e=33,f=33,g=-1,h=!1,k=["","","",""],l=[],m=!1,n=function(c){var d=0,g=e*f,h=Commons.GetTerrainByKey(a,c);for(var i in b)for(var j in b)b[i][j]<=h.getData().terrainUpperValue&&b[i][j]>=h.getData().terrainLowerValue&&d++;var k=d/g*100;return Commons.Log(h.getData().terrainKey+" Percentage of Terrain",k,Commons.validLogKeys.mapValidationLogKey),k},o=function(){if(m===!1){for(h===!1&&a[0].SetDefault(),i=0;i<e;i++){var c=[];for(j=0;j<f;j++)c.push(g);b.push(c)}Commons.Log("Map Values Empty",b,Commons.validLogKeys.mapInitializeLogKey),m=!0}},p=function(){k=["","","",""],l=[];var c=[],d=0,g=Commons.GetMainTerrains(a);Commons.Log("Regular Terrains",g,Commons.validLogKeys.mapInitializeLogKey);for(var h in g)if(g[h].terrainStartCount>0){var m={};m.terrainKey=g[h].terrainKey,m.count=g[h].terrainStartCount,m.nextPercent=g[h].terrainStartPercent,d+=g[h].terrainStartCount,c.push(m)}c.sort(function(a,b){return b.count-a.count});var n=4,o=[];if(4>=d){n=4-d;for(var p in c)for(j=0;j<c[p].count;j++){var q=Commons.RandomizeWithException(0,3,o);o.push(q),k[q]=c[p].terrainKey}}if(Commons.Log("Empty Non Optional Slots to Use",n,Commons.validLogKeys.mapInitializeLogKey),0!==n){var r=0,s=[],t=[];for(var u in g){var v={};g[u].terrainStartPercent>0?(r+=g[u].terrainStartPercent,v.terrainKey=g[u].terrainKey,v.cumulativePercent=r,s.push(v)):(v.terrainKey=g[u].terrainKey,t.push(v))}if(r>100);else for(i=0;i<n;i++){var w=Commons.RandomizeWithException(0,3,o);o.push(w);var x=Commons.Randomize(0,r),y=null,z=!1;for(var A in s)if(x<=s[A].cumulativePercent){z=!0,y=s[A].terrainKey;break}z===!1&&(y=Commons.RandomizeInArray(t).terrainKey),k[w]=y}}Commons.Log("Start Terrain Keys",k,Commons.validLogKeys.mapInitializeLogKey);for(var B in k){var C=Commons.GetTerrainByKey(a,k[B]);l.push(C.GetRandomTerrainValue())}Commons.Log("Start Terrain Values",l,Commons.validLogKeys.mapInitializeLogKey),b[0][0]=l[0],b[0][f-1]=l[1],b[e-1][0]=l[2],b[e-1][f-1]=l[3],Commons.Log("Map Values After Starting Values",b,Commons.validLogKeys.mapInitializeLogKey)},q=function(){var c=Commons.GetTerrainMaximum(a).getData().terrainUpperValue,e=Commons.GetTerrainMinimum(a).getData().terrainLowerValue;for(var f in b)for(var g in b)b[f][g]<e&&(b[f][g]=e),b[f][g]>c&&(b[f][g]=c);d=[]},r=function(){0!==d.length},s=function(a,b){Commons.Warn("Diamond Step Starting"),t(a/2,a/2,a,b),Commons.Warn("Square Step Starting"),u(a/2,a/2,a,b)},t=function(a,c,d,e){var f=Math.floor(d/2),g=Math.floor(f/2);Commons.Log("HalfBoxSize",f,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("QuarterBoxSize",g,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Average of",["["+(a-f)+"],["+(c-f)+"]","["+(a-f)+"],["+(c+f)+"]","["+(a+f)+"],["+(c-f)+"]","["+(a+f)+"],["+(c+f)+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a][c]=Commons.GetAverage([b[a-f][c-f],b[a-f][c+f],b[a+f][c-f],b[a+f][c+f]]),Commons.Log("Value of Center ["+a+"]["+c+"]",b[a][c],Commons.validLogKeys.diamondSquareLogKey),f>=2&&(t(a-g,c-g,f,e),t(a+g,c-g,f,e),t(a-g,c+g,f,e),t(a+g,c+g,f,e))},u=function(a,c,d,e){var f=Math.floor(d/2),g=Math.floor(f/2);Commons.Log("HalfBoxSize",f,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("QuarterBoxSize",g,Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Average of",["["+(a-f)+"],["+(c-f)+"]","["+a+"],["+c+"]","["+(a-f)+"],["+(c+f)+"]","["+(a-d)+"],["+c+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a-f][c]=Commons.GetAverage([Commons.TryGetArrayValue(b,a-f,c-f),Commons.TryGetArrayValue(b,a,c),Commons.TryGetArrayValue(b,a-f,c+f),Commons.TryGetArrayValue(b,a-d,c)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+(a-f)+"]["+c+"]",b[a-f][c],Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Average of",["["+(a+f)+"],["+(c-f)+"]","["+a+"],["+c+"]","["+(a+f)+"],["+(c+f)+"]","["+(a+d)+"],["+c+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a+f][c]=Commons.GetAverage([Commons.TryGetArrayValue(b,a+f,c-f),Commons.TryGetArrayValue(b,a,c),Commons.TryGetArrayValue(b,a+f,c+f),Commons.TryGetArrayValue(b,a+d,c)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+(a+f)+"]["+c+"]",b[a+f][c]),Commons.Log("Getting Average of",["["+(a-f)+"],["+(c-f)+"]","["+a+"],["+c+"]","["+(a+f)+"],["+(c-f)+"]","["+a+"],["+(c-d)+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a][c-f]=Commons.GetAverage([Commons.TryGetArrayValue(b,a-f,c-f),Commons.TryGetArrayValue(b,a,c),Commons.TryGetArrayValue(b,a+f,c-f),Commons.TryGetArrayValue(b,a,c-d)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+a+"]["+(c-f)+"]",b[a][c-f],Commons.validLogKeys.diamondSquareLogKey),Commons.Log("Getting Average of",["["+(a-f)+"],["+(c+f)+"]","["+a+"],["+c+"]","["+(a+f)+"],["+(c+f)+"]","["+a+"],["+(c+d)+"]"],Commons.validLogKeys.diamondSquareLogKey),b[a][c+f]=Commons.GetAverage([Commons.TryGetArrayValue(b,a-f,c+f),Commons.TryGetArrayValue(b,a,c),Commons.TryGetArrayValue(b,a+f,c+f),Commons.TryGetArrayValue(b,a,c+d)])+Commons.RandomizePlusMinus(0,5),Commons.Log("Value of ["+a+"]["+(c+f)+"]",b[a][c+f],Commons.validLogKeys.diamondSquareLogKey),f>=2&&(u(a-g,c-g,f,e),u(a+g,c-g,f,e),u(a-g,c+g,f,e),u(a+g,c+g,f,e))};this.SetDimensions=function(a,b){e=a,f=b},this.AddTerrain=function(b){var c=new ScaledTerrain;"zLevel"in b?c.CreateTerrain(b.label,b.key,b.max,b.min,b.zLevel):c.CreateTerrain(b.label,b.key,b.max,b.min,0),"type"in b&&c.SetType(b.type),"default"in b&&h===!1&&(h=!0,c.SetDefault()),Commons.Log("Adding Terrain",c.getData(),Commons.validLogKeys.mapInitializeLogKey),a.push(c)},this.AddStartingCondition=function(b){var c=Commons.GetTerrainByKey(a,b.terrainKey);c.SetStartingCondition(b.minCount,b.optionalPercent)},this.AddValidationRule=function(b){var c=b.terrainKey,d=-1,e=-1;"minPercent"in b&&(d=b.minPercent),"maxPercent"in b&&(e=b.maxPercent),Commons.GetTerrainByKey(a,c).SetValidation(d,e)},this.AddGidInfo=function(b){var c=b.terrainKey,d=b.gidData;Commons.GetTerrainByKey(a,c).SetGidInfo(d)},this.CheckRegularTerrainValidity=function(){var b=Commons.GetMainTerrains(a),c=!0;for(var e in b){var f=n(b[e].terrainKey),g=null;-1!=b[e].terrainValidationMinPercent&&f<b[e].terrainValidationMinPercent&&(c=!1,g=new ScaledValidityReport(b[e].terrainKey,Math.abs(f-b[e].terrainValidationMinPercent),!0)),-1!=b[e].terrainValidationMaxPercent&&f>b[e].terrainValidationMaxPercent&&(c=!1,g=new ScaledValidityReport(b[e].terrainKey,Math.abs(f-b[e].terrainValidationMaxPercent),!1)),null!==g&&d.push(g)}return Commons.Log("Validity Reports",d,Commons.validLogKeys.mapValidationLogKey),c},this.GenerateMapValues=function(){Commons.Warn("Map Init Starting"),Commons.Log("Terrains Before Map Generation",a,Commons.validLogKeys.mapInitializeLogKey),o(),p(),Commons.Warn("Pre Generation Clean Up"),r(),Commons.Warn("Diamond Square Algorithm Starting"),s(e-1,null),Commons.Warn("Post Generation Clean Up"),q()},this.GetLayersFromValue=function(b){var c=[];for(var d in a)a[d].getData().terrainUpperValue>=b&&a[d].getData().terrainLowerValue<=b&&c.push(a[d]);return c},this.GetNormalizedMap=function(){for(var a in b){var d=[];for(var e in b[a]){var f=this.GetLayersFromValue(b[a][e]);for(var g in f)if(f[g].IsRegularTerrain()===!0){terrainKey=f[g].getData().terrainKey;break}d.push(terrainKey)}c.push(d)}return c},this.GetTmxSettings=function(){this.GetNormalizedMap();var b={mapValues:c,terrains:a};return b},this.GetMapValues=function(){return b}},ScaledTerrain=function(){this.terrainKey=-1;var a=-1,b=-1,c=-1,d=-1,e="terrain",f=!1,g=0,h=0,i=-1,j=-1,k=-1;this.CreateTerrain=function(e,f,g,h,i){this.terrainKey=f,a=g,b=h,c=e,d=i},this.SetStartingCondition=function(a,b){h=b,g=a},this.SetDefault=function(){f=!0},this.SetType=function(a){e=a},this.GetRandomTerrainValue=function(){return Commons.Randomize(b,a)},this.IsRegularTerrain=function(){return"terrain"==e?!0:!1},this.SetValidation=function(a,b){i=a,j=b},this.SetGidInfo=function(a){k=a},this.getGidInfo=function(){return k},this.getData=function(){var l={terrainKey:this.terrainKey,terrainUpperValue:a,terrainLowerValue:b,terrainLabel:c,terrainZLevel:d,terrainType:e,terrainDefault:f,terrainStartCount:g,terrainStartPercent:h,terrainValidationMinPercent:i,terrainValidationMaxPercent:j,terrainGidInfo:k};return l}},ScaledTmxGen=function(a){var b=1,c="",d=[],e=[],f=[],g=null,h=null,i=null;a&&("mapValues"in a&&a.mapValues&&(e=a.mapValues),"terrains"in a&&a.terrains&&(d=a.terrains),"domSettings"in a&&a.domSettings&&(i=a.domSettings)),h={terrains:d,domination:i},g=new ScaledEdgeDetector(h);var j=function(a,b){var c=[];return a=parseInt(a),b=parseInt(b),c.push(Commons.TryGetArrayValue(e,a-1,b)),c.push(Commons.TryGetArrayValue(e,a,b+1)),c.push(Commons.TryGetArrayValue(e,a+1,b)),c.push(Commons.TryGetArrayValue(e,a,b-1)),c},k=function(a,b){var c=[];return a=parseInt(a),b=parseInt(b),c.push(Commons.TryGetArrayValue(e,a-1,b-1)),c.push(Commons.TryGetArrayValue(e,a-1,b+1)),c.push(Commons.TryGetArrayValue(e,a+1,b+1)),c.push(Commons.TryGetArrayValue(e,a+1,b-1)),c},l=function(){var a=[];for(var c in e){var d=[];for(var g in e[c])d.push(b);a.push(d)}f.push(a)},m=function(){var a=Commons.GetDefaultTerrain(d).getGidInfo().other.full,b=[];for(var c in e){var g=[];for(var h in e[c])g.push(a);b.push(g)}f.push(b)},n=function(a,b,c){for(var d in f)if(f[d][b][c]==a)return!0;return!1},o=function(a,c){for(var d in f)if(f[d][a][c]===b)return d;return-1},p=function(a,b,c){1===f.length&&l(),b=parseInt(b),c=parseInt(c);for(var d in a){var e=a[d];if(n(e,b,c)===!1){var g=o(b,c);if(-1!==g)f[g][b][c]=e;else{var h=f.length;l(),f[h][b][c]=e}}}},q=function(a){c+='<layer name="layer_'+a+'" width="'+f[0].length+'" height="'+f[0].length+'">',c+="<data>"},r=function(){c+="</data>",c+="</layer>"},s=function(a){c+='<tile gid="'+a+'" />'};this.GenerateMapTmx=function(){Commons.Warn("TMX - Generating Layered Map"),this.GenerateLayeredMap(),Commons.Warn("TMX - Generating Map XML"),this.GenerateMapXml()},this.GetTmxXml=function(){return c},this.GenerateLayeredMap=function(){m();for(var a in e)for(var b in e[a]){Commons.Log("Primary Pos",a+","+b,Commons.validLogKeys.tmxRenderLogKey);var c=j(a,b),d=k(a,b),f=g.ResolveTileValue(e[a][b],c,d);p(f,a,b)}},this.GenerateMapXml=function(){c+='<?xml version="1.0" encoding="UTF-8"?>',c+='<map version="1.0" orientation="orthogonal" renderorder="left-up" width="'+f[0].length+'" height="'+f[0].length+'" tilewidth="32" tileheight="32" nextobjectid="1">',c+='<tileset firstgid="1" name="tileset" tilewidth="32" tileheight="32">',c+='<image source="origin_tileset_3_layers.png" trans="ffffff" width="224" height="352"/>',c+="</tileset>";for(var a in f){q(a);for(var b in f[a])for(var d in f[a][b])s(f[a][b][d]);r()}c+="</map>"}},ScaledValidityReport=function(a,b,c){this.terrainKey=a,this.repairMagnitude=b,this.positiveIncrease=c},ScaledAutoReview=function(a,b){this.terrain=a,this.validityReport=b};